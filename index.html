<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Driver Registration</title>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts for Sinhala and Tamil support -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-red: #ff0000;
            --white: #ffffff;
            --gray-light: #f0f0f0;
            --text-dark: #333333;
            --radius: 15px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--white);
            overflow: hidden;
        }

        /* --- LOADER --- */
        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .glowing-dot {
            width: 20px;
            height: 20px;
            background-color: var(--primary-red);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-red), 0 0 20px var(--primary-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- MAIN LAYOUT --- */
        #app-container {
            display: none; /* Hidden until loaded */
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        /* Image Section (Top 3/4 approx, gets covered) */
        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 75%;
            overflow: hidden;
            z-index: 1;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Bottom Card (Bottom Half) */
        .bottom-card {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%; /* Half screen */
            background-color: var(--white);
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            z-index: 10;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* No shadows as requested */
        }

        /* Content Container for Animations */
        #card-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .slide-out-left {
            transform: translateX(-100%);
            opacity: 0;
        }

        .slide-in-right {
            animation: slideIn 0.4s forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Typography & Elements */
        h2 {
            font-size: 1.2rem;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .lang-btn {
            width: 90%;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            background: white;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }

        .lang-btn.selected {
            border: 2px solid var(--primary-red);
            color: var(--primary-red);
            font-weight: bold;
            background-color: #fff0f0;
        }

        .btn-continue {
            width: 90%;
            padding: 15px;
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            margin-top: auto; /* Push to bottom */
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-group {
            width: 90%;
            margin-bottom: 10px;
        }

        input[type="tel"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            font-size: 1.1rem;
            outline: none;
        }

        input:focus {
            border-color: var(--primary-red);
        }

        .terms-text {
            font-size: 0.75rem;
            color: #777;
            text-align: center;
            width: 90%;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        /* OTP Input Styles */
        .otp-container {
            display: flex;
            justify-content: space-between;
            width: 80%;
            margin: 20px 0;
        }

        .otp-box {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #ccc;
            border-radius: var(--radius);
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: var(--radius);
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;} 
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;} 
            to {bottom: 0; opacity: 0;}
        }

        /* Final Loading State within Card */
        .card-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        /* Helper to hide scrollbars on inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader-container">
        <div class="glowing-dot"></div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- App -->
    <div id="app-container">
        <div class="image-container">
            <!-- Lazy loaded via JS -->
            <img id="main-bg" alt="Speedo Background">
        </div>

        <div class="bottom-card">
            <div id="card-content">
                <!-- Dynamic Content Injected Here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDeCmIR6QnvCJWRgBYxgLinxwMIOmJfMxc",
            authDomain: "speedo-main.firebaseapp.com",
            databaseURL: "https://speedo-main-default-rtdb.firebaseio.com",
            projectId: "speedo-main",
            storageBucket: "speedo-main.firebasestorage.app",
            messagingSenderId: "3579467539",
            appId: "1:3579467539:web:5409255e200431edcbece6",
            measurementId: "G-9GTDXQ6E01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL VARIABLES & STATE ---
        let currentLang = 'en';
        let selectedPhone = '';
        let generatedOtp = '';
        let bypassOtp = false;

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                select_lang: "Select a language to continue",
                continue: "Continue",
                phone_title: "Enter your phone number",
                phone_hint: "e.g., 071XXXXXXX",
                invalid_phone: "Invalid phone number. Must be 10 digits starting with 07.",
                terms: "By logging in / registering on SPEEDO DRIVER, you agree to our terms and conditions. Visit SPEEDO website for more info",
                otp_sent: "OTP sent successfully.",
                verify_title: "Verify phone number",
                verify_btn: "Verify",
                wrong_otp: "Incorrect OTP. Please try again.",
                please_wait: "Please Wait...",
                registration: "Registration Form (New User)",
                welcome_back: "Welcome Back!"
            },
            si: {
                select_lang: "ඉදිරියට යාමට භාෂාවක් තෝරන්න",
                continue: "ඉදිරියට යන්න",
                phone_title: "ඔබගේ දුරකථන අංකය ඇතුළත් කරන්න",
                phone_hint: "උදා: 071XXXXXXX",
                invalid_phone: "දුරකථන අංකය වලංගු නොවේ. 07 න් ආරම්භ වන ඉලක්කම් 10 ක් විය යුතුය.",
                terms: "SPEEDO DRIVER වෙත පිවිසීමෙන් / ලියාපදිංචි වීමෙන්, ඔබ අපගේ නියමයන් සහ කොන්දේසි වලට එකඟ වේ. වැඩි විස්තර සඳහා SPEEDO වෙබ් අඩවියට පිවිසෙන්න",
                otp_sent: "OTP සාර්ථකව යවන ලදි.",
                verify_title: "දුරකථන අංකය තහවුරු කරන්න",
                verify_btn: "තහවුරු කරන්න",
                wrong_otp: "වැරදි OTP අංකයකි. නැවත උත්සාහ කරන්න.",
                please_wait: "කරුණාකර රැඳී සිටින්න...",
                registration: "ලියාපදිංචි වීමේ පෝරමය",
                welcome_back: "නැවතත් ආයුබෝවන්!"
            },
            ta: {
                select_lang: "தொடர மொழியைத் தேர்ந்தெடுக்கவும்",
                continue: "தொடரவும்",
                phone_title: "உங்கள் தொலைபேசி எண்ணை உள்ளிடவும்",
                phone_hint: "எ.கா. 071XXXXXXX",
                invalid_phone: "தவறான தொலைபேசி எண். 07 இல் தொடங்கும் 10 இலக்கங்களாக இருக்க வேண்டும்.",
                terms: "SPEEDO DRIVER இல் உள்நுழைவதன் / பதிவு செய்வதன் மூலம், எங்கள் விதிமுறைகள் மற்றும் நிபந்தனைகளை ஏற்கிறீர்கள். மேலும் தகவலுக்கு SPEEDO இணையதளத்தைப் பார்வையிடவும்",
                otp_sent: "OTP வெற்றிகரமாக அனுப்பப்பட்டது.",
                verify_title: "தொலைபேசி எண்ணை சரிபார்க்கவும்",
                verify_btn: "சரிபார்க்கவும்",
                wrong_otp: "தவறான OTP. மீண்டும் முயற்சிக்கவும்.",
                please_wait: "காத்திருக்கவும்...",
                registration: "பதிவு படிவம்",
                welcome_back: "மீண்டும் வருக!"
            }
        };

        // --- UTILS ---
        window.showToast = (message) => {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- API SMS FUNCTION ---
        window.sendSms = async (recipient, otp) => {
            // Recipient format conversion inside main logic, passed here as +94...
            try {
                // Determine message based on current lang
                let msg = "";
                if(currentLang === 'si') {
                    msg = `ඔබගේ SPEEDO තහවුරු කිරීමේ කේතය ${otp} වේ. කිසිවෙකු සමඟ බෙදා නොගන්න.`;
                } else if (currentLang === 'ta') {
                    msg = `உங்கள் SPEEDO சரிபார்ப்பு குறியீடு ${otp}. யாருடனும் பகிர வேண்டாம்.`;
                } else {
                    msg = `Your SPEEDO verification code is ${otp}. Please do not share this with anyone.`;
                }

                await fetch("https://app.text.lk/api/v3/sms/send", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer 2975|Wz0ile7QSbXVtBMEfs3qrJcFHiz74DOnCkgfnJni36b0e4bc`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: recipient, sender_id: "TextLKDemo", type: "plain", message: msg })
                });
                
                localStorage.setItem('speedo_otp_ts', Date.now().toString());
                window.showToast(translations[currentLang].otp_sent);
                renderStep('verify');
            } catch(e) { 
                console.error(e); 
                window.showToast("SMS Error: " + e.message);
            }
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            const img = document.getElementById('main-bg');
            img.onload = () => {
                // Image loaded, hide loader, show app
                setTimeout(() => {
                    document.getElementById('loader-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    
                    // Check local storage for lang
                    const storedLang = localStorage.getItem('speedo_lang');
                    if(storedLang) {
                        currentLang = storedLang;
                        renderStep('phone');
                    } else {
                        renderStep('language');
                    }
                }, 1000); // Small buffer
            };
            img.loading = "lazy";
            img.src = "https://i.ibb.co/spSLzC3f/hblj.jpg";
        };

        // --- RENDER LOGIC ---
        function renderStep(step) {
            const contentDiv = document.getElementById('card-content');
            
            // Animation class for transition
            contentDiv.classList.add('slide-out-left');

            setTimeout(() => {
                contentDiv.innerHTML = ''; // Clear content
                contentDiv.classList.remove('slide-out-left');
                contentDiv.classList.add('slide-in-right');

                if (step === 'language') {
                    renderLanguageStep(contentDiv);
                } else if (step === 'phone') {
                    renderPhoneStep(contentDiv);
                } else if (step === 'verify') {
                    renderVerifyStep(contentDiv);
                } else if (step === 'loading') {
                    renderLoadingStep(contentDiv);
                } else if (step === 'registration') {
                    renderRegistrationStep(contentDiv); // Not found in DB
                } else if (step === 'dashboard') {
                     renderDashboardStep(contentDiv); // Found in DB
                }

                // Remove animation class after playing
                setTimeout(() => {
                    contentDiv.classList.remove('slide-in-right');
                }, 400);

            }, 300); // Match CSS transition time
        }

        // --- STEP 1: LANGUAGE ---
        function renderLanguageStep(container) {
            const t = translations['en']; // Default for title before selection
            
            const title = document.createElement('h2');
            title.textContent = t.select_lang;
            
            const btnEn = createLangButton('English', 'en');
            const btnSi = createLangButton('සිංහල', 'si');
            const btnTa = createLangButton('தமிழ்', 'ta');

            const continueBtn = document.createElement('button');
            continueBtn.className = 'btn-continue';
            continueBtn.textContent = t.continue;
            continueBtn.style.display = 'none'; // Hidden initially
            continueBtn.onclick = () => {
                // Save Language
                localStorage.setItem('speedo_lang', currentLang);
                document.cookie = `speedo_lang=${currentLang}; path=/; max-age=31536000`; // 1 year
                renderStep('phone');
            };

            container.appendChild(title);
            container.appendChild(btnEn);
            container.appendChild(btnSi);
            container.appendChild(btnTa);
            container.appendChild(continueBtn);

            function createLangButton(text, code) {
                const btn = document.createElement('div');
                btn.className = 'lang-btn';
                btn.textContent = text;
                btn.onclick = () => {
                    // Reset others
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    currentLang = code;
                    // Update title immediately based on selection
                    title.textContent = translations[code].select_lang;
                    continueBtn.textContent = translations[code].continue;
                    continueBtn.style.display = 'flex';
                };
                return btn;
            }
        }

        // --- STEP 2: PHONE NUMBER ---
        function renderPhoneStep(container) {
            const t = translations[currentLang];

            const title = document.createElement('h2');
            title.textContent = t.phone_title;

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            
            const input = document.createElement('input');
            input.type = 'tel';
            input.placeholder = t.phone_hint;
            input.maxLength = 10;
            // Allow only numbers
            input.oninput = (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); };
            
            inputGroup.appendChild(input);

            const terms = document.createElement('p');
            terms.className = 'terms-text';
            terms.textContent = t.terms;

            const continueBtn = document.createElement('button');
            continueBtn.className = 'btn-continue';
            continueBtn.textContent = t.continue;
            
            continueBtn.onclick = () => {
                const val = input.value.trim();
                // Validate: 10 digits, starts with 07
                const phoneRegex = /^07[01245678][0-9]{7}$/;
                
                if (!phoneRegex.test(val)) {
                    window.showToast(t.invalid_phone);
                    return;
                }

                selectedPhone = val;
                
                // Logic for bypass or API
                if (val === '0785955357') {
                    bypassOtp = true;
                    generatedOtp = '1234';
                    // Skip API, go straight to verify simulation
                    renderStep('verify');
                } else {
                    bypassOtp = false;
                    generatedOtp = Math.floor(1000 + Math.random() * 9000).toString(); // Generate 4 digit OTP
                    const formattedNum = '+94' + val.substring(1);
                    window.sendSms(formattedNum, generatedOtp);
                }
            };

            container.appendChild(title);
            container.appendChild(inputGroup);
            container.appendChild(continueBtn); // Button before terms visual, or after? Prompt says "after continue button add text". 
            // Correcting order based on prompt: Button -> Text
            container.appendChild(terms);
        }

        // --- STEP 3: VERIFY OTP ---
        function renderVerifyStep(container) {
            const t = translations[currentLang];

            const title = document.createElement('h2');
            title.textContent = t.verify_title;

            const otpDiv = document.createElement('div');
            otpDiv.className = 'otp-container';

            const inputs = [];
            for(let i=0; i<4; i++) {
                const box = document.createElement('input');
                box.type = 'number'; // Mobile numeric pad
                box.className = 'otp-box';
                box.maxLength = 1;
                
                // Auto focus logic
                box.onkeyup = (e) => {
                    if (e.key >= 0 && e.key <= 9 || e.key === 'Backspace') {
                        if (box.value.length === 1 && i < 3) {
                            inputs[i+1].focus();
                        }
                        if (e.key === 'Backspace' && i > 0) {
                            inputs[i-1].focus();
                        }
                    } else {
                        // Prevent non-numeric via js fallback if type=number fails
                        box.value = box.value.replace(/[^0-9]/g, '');
                    }
                };
                
                // Sanitize input to 1 char
                box.oninput = (e) => {
                    if(box.value.length > 1) box.value = box.value.slice(0, 1);
                };

                inputs.push(box);
                otpDiv.appendChild(box);
            }

            const verifyBtn = document.createElement('button');
            verifyBtn.className = 'btn-continue';
            verifyBtn.textContent = t.verify_btn;

            verifyBtn.onclick = () => {
                const enteredOtp = inputs.map(i => i.value).join('');
                if (enteredOtp === generatedOtp) {
                    renderStep('loading');
                } else {
                    window.showToast(t.wrong_otp);
                    inputs.forEach(i => i.value = '');
                    inputs[0].focus();
                }
            };

            container.appendChild(title);
            container.appendChild(otpDiv);
            container.appendChild(verifyBtn);
        }

        // --- STEP 4: LOADING / CHECK DATABASE ---
        function renderLoadingStep(container) {
            const t = translations[currentLang];
            
            const loaderWrapper = document.createElement('div');
            loaderWrapper.className = 'card-loader';

            const dot = document.createElement('div');
            dot.className = 'glowing-dot';
            
            const label = document.createElement('h2');
            label.style.marginTop = "20px";
            label.textContent = t.please_wait;

            loaderWrapper.appendChild(dot);
            loaderWrapper.appendChild(label);
            container.appendChild(loaderWrapper);

            // Trigger Firebase Check
            checkDatabase();
        }

        async function checkDatabase() {
            // Convert local format to expected DB format (assuming generic numeric ID or formatted phone)
            // Storing without '0' prefix typically, or with +94. Let's assume +94 format is the key or local format.
            // Using formatted local 07XXXXXXXX based on prompt variable
            
            // NOTE: "If found (I'll tell what to do) and if notfound, show the registration screen."
            // Assuming DB stores drivers by phone number.
            
            const dbRef = ref(db);
            // Checking users path (Standard convention)
            // Trying both formats just in case, or just the input number. 
            // Using selectedPhone (07XXXXXXXX) directly as ID is safest if not specified.
            const userId = selectedPhone; 

            try {
                const snapshot = await get(child(dbRef, `drivers/${userId}`));
                if (snapshot.exists()) {
                    // FOUND
                    // Prompt: "if found (i`ll tell what to do)" - Implementation: Show placeholder success/dashboard
                    renderStep('dashboard');
                } else {
                    // NOT FOUND
                    renderStep('registration');
                }
            } catch (error) {
                console.error(error);
                window.showToast("Database Error");
            }
        }

        // --- STEP 5: REGISTRATION (Placeholder) ---
        function renderRegistrationStep(container) {
             const t = translations[currentLang];
             const title = document.createElement('h2');
             title.textContent = t.registration;
             title.style.color = 'var(--primary-red)';
             
             const info = document.createElement('p');
             info.textContent = selectedPhone;
             info.style.fontSize = "1.2rem";
             info.style.fontWeight = "bold";

             container.appendChild(title);
             container.appendChild(info);
             
             // Add registration form fields here in future
        }

        // --- STEP 6: FOUND (Placeholder) ---
        function renderDashboardStep(container) {
             const t = translations[currentLang];
             const title = document.createElement('h2');
             title.textContent = t.welcome_back;
             
             const icon = document.createElement('i');
             icon.className = "material-icons";
             icon.textContent = "check_circle";
             icon.style.color = "var(--primary-red)";
             icon.style.fontSize = "50px";

             container.appendChild(title);
             container.appendChild(icon);
        }

    </script>
</body>
</html>
