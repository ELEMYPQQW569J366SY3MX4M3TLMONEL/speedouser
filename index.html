<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Driver</title>
    <!-- Material Icons CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-red: #ff0000;
            --white: #ffffff;
            --gray-light: #f0f0f0;
            --text-dark: #333333;
            /* UPDATED: Very small radius */
            --radius: 5px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--white);
            overflow: hidden;
        }

        /* --- LOADER --- */
        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .glowing-dot {
            width: 20px;
            height: 20px;
            background-color: var(--primary-red);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-red), 0 0 20px var(--primary-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- MAIN LAYOUT --- */
        #app-container {
            opacity: 0;
            transition: opacity 0.5s ease;
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        /* Image Section - 3/4 of screen */
        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 75%; /* 3/4 Height */
            overflow: hidden;
            z-index: 1;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Bottom Card - Overlaps image */
        .bottom-card {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%; /* Slightly less than half to ensure 3/4 image feel, but covers enough */
            background-color: var(--white);
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            z-index: 10;
            padding: 20px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Shadow to separate from image visual if needed, but requested 'no shadows' on card itself? 
               Prompt said "without any shadows". Adhering to that. */
        }

        #card-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Aligns content to top to reduce space */
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .slide-out-left { transform: translateX(-100%); opacity: 0; }
        .slide-in-right { animation: slideIn 0.4s forwards; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Typography */
        h2 {
            font-size: 1.2rem;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 15px; /* Reduced margin */
            margin-top: 5px;
            font-weight: 700;
        }

        /* Buttons & Inputs */
        .lang-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px; /* Tighter spacing */
            border: 1px solid #ccc;
            border-radius: var(--radius);
            background: white;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }

        .lang-btn.selected {
            border: 2px solid var(--primary-red);
            color: var(--primary-red);
            font-weight: bold;
            background-color: #fff0f0;
        }

        .btn-continue {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            margin-top: 15px; /* Fixed small margin, no longer pushed to bottom */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-group {
            width: 100%;
            margin-bottom: 5px;
        }

        input[type="tel"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 14px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            font-size: 1.1rem;
            outline: none;
        }

        input:focus {
            border-color: var(--primary-red);
        }

        .terms-text {
            font-size: 0.7rem;
            color: #777;
            text-align: center;
            width: 100%;
            margin-top: 10px;
            line-height: 1.3;
        }

        /* UPDATED OTP STYLES */
        .otp-container {
            display: flex;
            justify-content: space-between; /* Spreads them out */
            width: 100%;
            max-width: 320px; /* Limit width */
            margin: 20px 0;
            gap: 15px; /* "Space between each otp box more higher" */
        }

        .otp-box {
            width: 55px;
            height: 55px;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            background: #fafafa;
        }
        
        .otp-guide-text {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 5px;
        }

        .resend-link {
            font-size: 0.85rem;
            color: var(--primary-red);
            text-decoration: underline;
            margin-top: 15px;
            cursor: pointer;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: var(--radius);
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .card-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>

    <div id="loader-container">
        <div class="glowing-dot"></div>
    </div>

    <div id="toast"></div>

    <div id="app-container">
        <div class="image-container">
            <img id="main-bg" alt="Speedo Background">
        </div>

        <div class="bottom-card">
            <div id="card-content">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeCmIR6QnvCJWRgBYxgLinxwMIOmJfMxc",
            authDomain: "speedo-main.firebaseapp.com",
            databaseURL: "https://speedo-main-default-rtdb.firebaseio.com",
            projectId: "speedo-main",
            storageBucket: "speedo-main.firebasestorage.app",
            messagingSenderId: "3579467539",
            appId: "1:3579467539:web:5409255e200431edcbece6",
            measurementId: "G-9GTDXQ6E01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentLang = 'en';
        let selectedPhone = '';
        let generatedOtp = '';
        let bypassOtp = false;

        const translations = {
            en: {
                select_lang: "Select a language to continue",
                continue: "Continue",
                phone_title: "Enter your phone number",
                phone_hint: "e.g., 071XXXXXXX",
                invalid_phone: "Invalid phone number. Must be 10 digits starting with 07.",
                terms: "By logging in / registering on SPEEDO DRIVER, you agree to our terms and conditions.",
                otp_sent: "OTP sent successfully.",
                verify_title: "Verify phone number",
                verify_btn: "Verify",
                wrong_otp: "Incorrect OTP.",
                please_wait: "Please Wait...",
                registration: "Registration",
                welcome_back: "Welcome Back!",
                enter_code_guide: "Enter the 4-digit code",
                resend_code: "Resend Code"
            },
            si: {
                select_lang: "ඉදිරියට යාමට භාෂාවක් තෝරන්න",
                continue: "ඉදිරියට යන්න",
                phone_title: "ඔබගේ දුරකථන අංකය ඇතුළත් කරන්න",
                phone_hint: "උදා: 071XXXXXXX",
                invalid_phone: "දුරකථන අංකය වලංගු නොවේ.",
                terms: "SPEEDO DRIVER වෙත පිවිසීමෙන් ඔබ අපගේ කොන්දේසි වලට එකඟ වේ.",
                otp_sent: "OTP යවන ලදි.",
                verify_title: "දුරකථන අංකය තහවුරු කරන්න",
                verify_btn: "තහවුරු කරන්න",
                wrong_otp: "වැරදි OTP අංකයකි.",
                please_wait: "රැඳී සිටින්න...",
                registration: "ලියාපදිංචි වන්න",
                welcome_back: "නැවතත් ආයුබෝවන්!",
                enter_code_guide: "අංක 4 කේතය ඇතුළත් කරන්න",
                resend_code: "නැවත කේතය යවන්න"
            },
            ta: {
                select_lang: "தொடர மொழியைத் தேர்ந்தெடுக்கவும்",
                continue: "தொடரவும்",
                phone_title: "தொலைபேசி எண்ணை உள்ளிடவும்",
                phone_hint: "எ.கா. 071XXXXXXX",
                invalid_phone: "தவறான தொலைபேசி எண்.",
                terms: "SPEEDO DRIVER இல் உள்நுழைவதன் மூலம் விதிகளை ஏற்கிறீர்கள்.",
                otp_sent: "OTP அனுப்பப்பட்டது.",
                verify_title: "எண்ணை சரிபார்க்கவும்",
                verify_btn: "சரிபார்க்கவும்",
                wrong_otp: "தவறான OTP.",
                please_wait: "காத்திருக்கவும்...",
                registration: "பதிவு",
                welcome_back: "மீண்டும் வருக!",
                enter_code_guide: "4 இலக்க குறியீட்டை உள்ளிடவும்",
                resend_code: "மீண்டும் அனுப்பு"
            }
        };

        window.showToast = (message) => {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }

        window.sendSms = async (recipient, otp) => {
            try {
                let msg = `Your SPEEDO code is ${otp}.`;
                if(currentLang === 'si') msg = `SPEEDO කේතය: ${otp}`;
                if(currentLang === 'ta') msg = `SPEEDO குறியீடு: ${otp}`;

                await fetch("https://app.text.lk/api/v3/sms/send", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer 2975|Wz0ile7QSbXVtBMEfs3qrJcFHiz74DOnCkgfnJni36b0e4bc`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: recipient, sender_id: "TextLKDemo", type: "plain", message: msg })
                });
                
                window.showToast(translations[currentLang].otp_sent);
                renderStep('verify');
            } catch(e) { 
                console.error(e); 
                window.showToast("SMS Error");
            }
        };

        async function initApp() {
            const imgEl = document.getElementById('main-bg');
            const bgUrl = "https://i.ibb.co/spSLzC3f/hblj.jpg";
            
            const p1 = new Promise(r => {
                imgEl.onload = () => r();
                imgEl.onerror = () => r();
                imgEl.src = bgUrl;
                if(imgEl.complete) r();
            });

            const p2 = document.fonts.ready.then(() => {
                 if(!document.fonts.check('1em "Material Icons"')) return document.fonts.load('1em "Material Icons"');
            });
            const p3 = new Promise(r => setTimeout(r, 4000));

            await Promise.race([Promise.all([p1, p2]), p3]);

            document.getElementById('loader-container').style.opacity = '0';
            document.getElementById('app-container').style.opacity = '1';
            
            setTimeout(() => {
                document.getElementById('loader-container').style.display = 'none';
                const lang = localStorage.getItem('speedo_lang');
                if(lang) { currentLang = lang; renderStep('phone'); }
                else renderStep('language');
            }, 500);
        }

        initApp();

        function renderStep(step) {
            const content = document.getElementById('card-content');
            content.classList.add('slide-out-left');

            setTimeout(() => {
                content.innerHTML = '';
                content.classList.remove('slide-out-left');

                switch(step) {
                    case 'language': stepLanguage(content); break;
                    case 'phone': stepPhone(content); break;
                    case 'verify': stepVerify(content); break;
                    case 'loading': stepLoading(content); break;
                    case 'dashboard': stepDashboard(content); break;
                    case 'registration': stepRegistration(content); break;
                }

                content.classList.add('slide-in-right');
                setTimeout(() => content.classList.remove('slide-in-right'), 400);
            }, 300);
        }

        function stepLanguage(div) {
            const t = translations['en'];
            const h2 = document.createElement('h2'); h2.textContent = t.select_lang;
            
            const btnEn = mkBtn('English', 'en', h2);
            const btnSi = mkBtn('සිංහල', 'si', h2);
            const btnTa = mkBtn('தமிழ்', 'ta', h2);

            const cont = document.createElement('button');
            cont.className = 'btn-continue';
            cont.textContent = t.continue;
            cont.style.display = 'none';
            cont.onclick = () => {
                localStorage.setItem('speedo_lang', currentLang);
                renderStep('phone');
            };

            div.append(h2, btnEn, btnSi, btnTa, cont);

            function mkBtn(txt, code, titleEl) {
                const b = document.createElement('div');
                b.className = 'lang-btn';
                b.textContent = txt;
                b.onclick = () => {
                    document.querySelectorAll('.lang-btn').forEach(x => x.classList.remove('selected'));
                    b.classList.add('selected');
                    currentLang = code;
                    titleEl.textContent = translations[code].select_lang;
                    cont.textContent = translations[code].continue;
                    cont.style.display = 'flex';
                };
                return b;
            }
        }

        function stepPhone(div) {
            const t = translations[currentLang];
            const h2 = document.createElement('h2'); h2.textContent = t.phone_title;
            
            const grp = document.createElement('div'); grp.className = 'input-group';
            const inp = document.createElement('input'); 
            inp.type = 'tel'; 
            inp.placeholder = t.phone_hint;
            inp.maxLength = 10;
            inp.oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
            grp.appendChild(inp);

            const btn = document.createElement('button');
            btn.className = 'btn-continue';
            btn.textContent = t.continue;
            
            const terms = document.createElement('p');
            terms.className = 'terms-text';
            terms.textContent = t.terms;

            btn.onclick = () => {
                const v = inp.value.trim();
                if(!/^07[0-9]{8}$/.test(v)) return window.showToast(t.invalid_phone);
                
                selectedPhone = v;
                if(v === '0785955357') {
                    bypassOtp = true; generatedOtp = '1234'; renderStep('verify');
                } else {
                    bypassOtp = false; 
                    generatedOtp = Math.floor(1000 + Math.random()*9000).toString();
                    window.sendSms('+94'+v.substring(1), generatedOtp);
                }
            };
            
            div.append(h2, grp, btn, terms);
        }

        function stepVerify(div) {
            const t = translations[currentLang];
            const h2 = document.createElement('h2'); h2.textContent = t.verify_title;

            const guide = document.createElement('p');
            guide.className = 'otp-guide-text';
            guide.textContent = t.enter_code_guide;

            const boxCont = document.createElement('div');
            boxCont.className = 'otp-container';
            
            const inputs = [];
            for(let i=0; i<4; i++){
                const b = document.createElement('input');
                b.type='number'; 
                b.className='otp-box';
                b.placeholder = '-'; // Guide placeholder
                b.oninput = () => { if(b.value.length>1) b.value=b.value[0]; };
                b.onkeyup = (e) => {
                    if((e.key>=0 && e.key<=9) || e.key==='Backspace'){
                         if(b.value.length===1 && i<3) inputs[i+1].focus();
                         if(e.key==='Backspace' && i>0) inputs[i-1].focus();
                    } else if(b.value.length===1 && i<3) inputs[i+1].focus();
                };
                inputs.push(b);
                boxCont.appendChild(b);
            }

            const btn = document.createElement('button');
            btn.className = 'btn-continue';
            btn.textContent = t.verify_btn;

            const resend = document.createElement('div');
            resend.className = 'resend-link';
            resend.textContent = t.resend_code;
            resend.onclick = () => {
                 // Resend logic
                 generatedOtp = Math.floor(1000 + Math.random()*9000).toString();
                 window.showToast("Resending...");
                 if(!bypassOtp) window.sendSms('+94'+selectedPhone.substring(1), generatedOtp);
            };

            btn.onclick = () => {
                if(inputs.map(x=>x.value).join('') === generatedOtp) renderStep('loading');
                else {
                    window.showToast(t.wrong_otp);
                    inputs.forEach(x=>x.value='');
                    inputs[0].focus();
                }
            };

            div.append(h2, guide, boxCont, btn, resend);
        }

        function stepLoading(div) {
            const w = document.createElement('div'); w.className='card-loader';
            const d = document.createElement('div'); d.className='glowing-dot';
            const l = document.createElement('h2'); l.textContent = translations[currentLang].please_wait;
            l.style.marginTop='20px';
            w.append(d,l);
            div.appendChild(w);

            const dbRef = ref(db);
            get(child(dbRef, `drivers/${selectedPhone}`)).then((snap) => {
                if(snap.exists()) renderStep('dashboard');
                else renderStep('registration');
            }).catch(() => {
                window.showToast("DB Error");
                renderStep('registration'); 
            });
        }

        function stepRegistration(div) {
            const h = document.createElement('h2');
            h.textContent = translations[currentLang].registration;
            h.style.color = 'var(--primary-red)';
            const p = document.createElement('p'); p.textContent = selectedPhone;
            p.style.fontWeight = 'bold';
            div.append(h, p);
        }

        function stepDashboard(div) {
            const h = document.createElement('h2');
            h.textContent = translations[currentLang].welcome_back;
            const i = document.createElement('i');
            i.className = 'material-icons';
            i.textContent = 'check_circle';
            i.style.color = 'var(--primary-red)';
            i.style.fontSize = '60px';
            div.append(h, i);
        }
    </script>
</body>
</html>
