<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Driver</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-red: #ff0000;
            --primary-red-dark: #cc0000;
            --success-green: #28a745;
            --white: #ffffff;
            --text-dark: #333333;
            --radius: 8px; 
            --anim-speed: 0.35s;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--white);
            overflow: hidden;
        }

        /* --- LOADER --- */
        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .glowing-dot {
            width: 20px;
            height: 20px;
            background-color: var(--primary-red);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-red), 0 0 20px var(--primary-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- LAYOUT --- */
        #app-container {
            opacity: 0;
            transition: opacity 0.5s ease;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column; 
            position: relative;
        }

        .image-container {
            flex: 1; 
            width: 100%;
            position: relative;
            overflow: hidden;
            z-index: 1;
            transition: height 0.5s ease;
        }

        .image-container.hidden {
            display: none;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Bottom Card */
        .bottom-card {
            width: 100%;
            background-color: var(--white);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 10;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: auto;
            will-change: height;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        /* Full Screen Mode for Registration */
        .bottom-card.expanded {
            height: 100vh !important;
            border-radius: 0;
            padding: 0;
            overflow-y: auto;
            justify-content: flex-start;
        }

        #card-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* In expanded mode, add padding for scroll */
        }
        
        .expanded #card-content {
            padding: 80px 20px 40px 20px; /* Top padding for sticky bar */
            max-width: 600px;
        }

        /* Progress Bar (Sticky Top) */
        #reg-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: white;
            z-index: 50;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 0 20px;
        }
        
        .progress-track {
            width: 100%;
            max-width: 400px;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red), #ff4d4d);
            width: 33%;
            transition: width 0.4s ease;
        }

        .step-label {
            position: absolute;
            top: 40px;
            font-size: 0.75rem;
            color: #888;
            font-weight: bold;
        }

        /* Content Animations */
        .slide-out-left { animation: slideOut var(--anim-speed) forwards; }
        .slide-in-right { animation: slideIn var(--anim-speed) forwards; }

        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-50px); opacity: 0; } }

        h2 {
            font-size: 1.3rem;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 20px; 
            margin-top: 5px;
            font-weight: 700;
        }
        
        h3 {
            font-size: 1.1rem;
            color: #555;
            align-self: flex-start;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }

        /* BUTTONS & INPUTS */
        .lang-btn {
            width: 100%; padding: 12px; margin-bottom: 8px;
            border: 1px solid #ccc; border-radius: var(--radius);
            background: white; font-size: 1rem; cursor: pointer; text-align: center;
            transition: all 0.2s ease;
        }
        .lang-btn.selected { border: 2px solid var(--primary-red); color: var(--primary-red); font-weight: bold; background-color: #fff0f0; }

        .btn-continue {
            width: 100%; padding: 14px;
            background-color: var(--primary-red); color: white;
            border: none; border-radius: var(--radius);
            font-size: 1rem; margin-top: 25px; 
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(255, 0, 0, 0.2);
        }
        .btn-continue:active { transform: scale(0.97); }

        .input-group { width: 100%; margin-bottom: 12px; position: relative; }
        
        label {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
            margin-left: 2px;
        }

        input, select {
            width: 100%; padding: 14px;
            border: 1px solid #ddd; border-radius: var(--radius);
            font-size: 1rem; outline: none; background: #fff;
            transition: border-color 0.3s, background-color 0.3s;
        }

        input:focus, select:focus { border-color: var(--primary-red); }
        
        /* Validation Highlights */
        input.valid, select.valid {
            border-color: var(--success-green);
            background-color: #f0fff4;
        }
        
        input[readonly] { background-color: #f9f9f9; color: #777; border-color: #eee; }

        .terms-container {
            display: flex; align-items: flex-start; gap: 10px; margin-top: 15px; width: 100%;
        }
        .terms-text { font-size: 0.8rem; color: #555; line-height: 1.4; }

        /* Documents Grid */
        .doc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }
        .doc-card {
            background: #f8f8f8; border: 1px dashed #ccc;
            border-radius: var(--radius);
            height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.3s;
        }
        .doc-card.uploaded { border: 2px solid var(--success-green); background: #e8f5e9; border-style: solid; }
        .doc-card i { font-size: 24px; color: #999; margin-bottom: 5px; }
        .doc-card span { font-size: 0.7rem; color: #666; text-align: center; padding: 0 5px; }
        .doc-card img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 1; }
        .doc-card-overlay { z-index: 2; background: rgba(255,255,255,0.8); padding: 2px 5px; border-radius: 4px; }

        /* Profile Photo */
        .profile-section {
            width: 100%; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        .profile-circle {
            width: 140px; height: 180px; /* Oval shape */
            border-radius: 50%;
            background: #f0f0f0;
            border: 3px dashed #ccc;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
            cursor: pointer;
        }
        .profile-circle.uploaded { border-color: var(--success-green); border-style: solid; }
        .profile-circle img { width: 100%; height: 100%; object-fit: cover; }
        .camera-icon { font-size: 40px; color: #ccc; z-index: 2; }

        /* Pending Screen */
        .pending-container { text-align: center; padding: 40px 20px; }
        .pending-icon { font-size: 80px; color: #f39c12; margin-bottom: 20px; animation: pulse 2s infinite; }

        /* Toast & OTP Styles (Existing) */
        .otp-container { display: flex; justify-content: space-between; width: 100%; max-width: 320px; margin: 20px 0; gap: 15px; }
        .otp-box { width: 55px; height: 55px; text-align: center; font-size: 1.5rem; border: 1px solid #ccc; border-radius: var(--radius); background: #fafafa; }
        .otp-box:focus { border-color: var(--primary-red); }
        .resend-link { font-size: 0.85rem; color: var(--primary-red); text-decoration: underline; margin-top: 15px; cursor: pointer; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: var(--radius); padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loader-container">
        <div class="glowing-dot"></div>
    </div>

    <!-- Sticky Progress Bar -->
    <div id="reg-progress-bar">
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <div id="toast"></div>

    <div id="app-container">
        <div class="image-container" id="top-image">
            <img id="main-bg" alt="Speedo Background">
        </div>

        <div class="bottom-card" id="main-card">
            <div id="card-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Hidden Canvas for Compression -->
    <canvas id="compress-canvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, get, child, set } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeCmIR6QnvCJWRgBYxgLinxwMIOmJfMxc",
            authDomain: "speedo-main.firebaseapp.com",
            databaseURL: "https://speedo-main-default-rtdb.firebaseio.com",
            projectId: "speedo-main",
            storageBucket: "speedo-main.firebasestorage.app",
            messagingSenderId: "3579467539",
            appId: "1:3579467539:web:5409255e200431edcbece6",
            measurementId: "G-9GTDXQ6E01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentLang = 'en';
        let selectedPhone = '';
        let generatedOtp = '';
        let bypassOtp = false;

        // Registration State
        let regData = {
            personal: {},
            vehicle: {},
            files: {} // base64 strings
        };

        // --- DATA SETS ---
        const provinces = ["Western", "Central", "Southern", "Northern", "Eastern", "North Western", "North Central", "Uva", "Sabaragamuwa"];
        const districtMap = {
            "Western": ["Colombo", "Gampaha", "Kalutara"],
            "Central": ["Kandy", "Matale", "Nuwara Eliya"],
            "Southern": ["Galle", "Matara", "Hambantota"],
            "North Western": ["Kurunegala", "Puttalam"],
            // Simplified for demo
            "Northern": ["Jaffna", "Kilinochchi", "Mannar"],
            "Eastern": ["Batticaloa", "Ampara", "Trincomalee"],
            "North Central": ["Anuradhapura", "Polonnaruwa"],
            "Uva": ["Badulla", "Monaragala"],
            "Sabaragamuwa": ["Ratnapura", "Kegalle"]
        };

        const vehicleTypes = ["Bike", "Tuk Tuk", "Car", "Mini Car", "Van", "Mini Van"];
        const brands = ["Toyota", "Honda", "Nissan", "Suzuki", "Bajaj", "TVS", "Yamaha", "Kia", "Hyundai"];
        const models = {
            "Toyota": ["Corolla", "Vitz", "Axio", "Prius", "Allion"],
            "Honda": ["Civic", "Fit", "Vezel", "Grace", "Insight"],
            "Suzuki": ["Alto", "WagonR", "Swift", "Celerio", "Every"],
            "Bajaj": ["RE 4S", "Pulsar", "CT 100", "Platina"],
            "Nissan": ["Sunny", "Leaf", "March", "Dayz"],
            // Fallback
            "Default": ["Model X", "Model Y", "Standard"]
        };

        const translations = {
            en: {
                select_lang: "Select a language", continue: "Continue", phone_title: "Enter your phone number", phone_hint: "e.g., 071XXXXXXX",
                invalid_phone: "Invalid phone number", terms: "By continuing, you agree to our Terms & Conditions.",
                otp_sent: "OTP Sent!", verify_title: "Verify Phone", verify_btn: "Verify", wrong_otp: "Incorrect OTP",
                please_wait: "Please Wait...", resend_code: "Resend Code", enter_code_guide: "Enter the 4-digit code",
                // Registration Step 1
                reg_title_1: "Personal Details", name_lbl: "Full Name", addr_lbl: "Address", 
                prov_lbl: "Province", dist_lbl: "District", nic_lbl: "NIC Number", email_lbl: "Email (Optional)",
                nic_hint: "Old (9+V/X) or New (12 digits)", agree_terms: "I agree to the Terms & Conditions and Privacy Policy.",
                // Step 2
                reg_title_2: "Vehicle Details", type_lbl: "Vehicle Type", brand_lbl: "Brand", 
                model_lbl: "Model", plate_lbl: "Number Plate (ABC-1234)", year_lbl: "Manufactured Year",
                // Step 3
                reg_title_3: "Documents & Profile", upload_guide: "Tap to upload. Green means ready.",
                doc_fv: "Vehicle Front", doc_bv: "Vehicle Back", doc_nic_f: "NIC Front", doc_nic_b: "NIC Back",
                doc_lic: "License Front", doc_ins: "Insurance", doc_rev: "Revenue Permit",
                profile_lbl: "Profile Photo (Face only)", register_btn: "Register", processing: "Processing Images...",
                // Pending
                pending_title: "Pending Approval",
                pending_msg: "Your application is being reviewed by our team. We will contact you within 2-3 business days.",
                check_back: "Check back later."
            },
            si: {
                select_lang: "භාෂාවක් තෝරන්න", continue: "ඉදිරියට යන්න", phone_title: "දුරකථන අංකය ඇතුළත් කරන්න", phone_hint: "උදා: 071XXXXXXX",
                invalid_phone: "අවලංගු අංකයකි", terms: "අපගේ කොන්දේසි වලට එකඟ වේ.",
                otp_sent: "OTP යවන ලදි", verify_title: "අංකය තහවුරු කරන්න", verify_btn: "තහවුරු කරන්න", wrong_otp: "වැරදි OTP අංකයකි",
                please_wait: "රැඳී සිටින්න...", resend_code: "නැවත එවන්න", enter_code_guide: "අංක 4 කේතය ඇතුලත් කරන්න",
                reg_title_1: "පෞද්ගලික විස්තර", name_lbl: "සම්පූර්ණ නම", addr_lbl: "ලිපිනය",
                prov_lbl: "පළාත", dist_lbl: "දිස්ත්‍රික්කය", nic_lbl: "ජා. හැ. අංකය", email_lbl: "විද්‍යුත් තැපෑල (විකල්ප)",
                nic_hint: "පැරණි (9V) හෝ නව (12)", agree_terms: "මම නියමයන් සහ කොන්දේසි වලට එකඟ වෙමි.",
                reg_title_2: "වාහන විස්තර", type_lbl: "වාහන වර්ගය", brand_lbl: "වෙළඳ නාමය",
                model_lbl: "මාදිලිය", plate_lbl: "ලියාපදිංචි අංකය (ABC-1234)", year_lbl: "නිෂ්පාදිත වර්ෂය",
                reg_title_3: "ලේඛන සහ ඡායාරූප", upload_guide: "ඡායාරූප ඇතුලත් කිරීමට ඔබන්න.",
                doc_fv: "වාහනය ඉදිරිපස", doc_bv: "වාහනය පිටුපස", doc_nic_f: "ජා.හැ. ඉදිරිපස", doc_nic_b: "ජා.හැ. පිටුපස",
                doc_lic: "රියදුරු බලපත්‍රය", doc_ins: "රක්ෂණ සහතිකය", doc_rev: "ආදායම් බලපත්‍රය",
                profile_lbl: "ඔබගේ ඡායාරූපය", register_btn: "ලියාපදිංචි වන්න", processing: "සකසමින් පවතී...",
                pending_title: "අනුමැතිය අපේක්ෂාවෙන්",
                pending_msg: "ඔබගේ අයදුම්පත අපගේ කණ්ඩායම විසින් පරීක්ෂා කරමින් පවතී. ව්‍යාපාරික දින 2-3 ක් ඇතුලත අප ඔබව අමතන්නෙමු.",
                check_back: "පසුව නැවත පරීක්ෂා කරන්න."
            },
            ta: {
                select_lang: "மொழியைத் தேர்ந்தெடுக்கவும்", continue: "தொடரவும்", phone_title: "தொலைபேசி எண்", phone_hint: "எ.கா. 071XXXXXXX",
                invalid_phone: "தவறான எண்", terms: "விதிமுறைகளை ஏற்கிறீர்கள்.",
                otp_sent: "OTP அனுப்பப்பட்டது", verify_title: "சரிபார்க்கவும்", verify_btn: "சரிபார்க்கவும்", wrong_otp: "தவறான OTP",
                please_wait: "காத்திருக்கவும்...", resend_code: "மீண்டும் அனுப்பு", enter_code_guide: "குறியீட்டை உள்ளிடவும்",
                reg_title_1: "தனிப்பட்ட விவரங்கள்", name_lbl: "முழு பெயர்", addr_lbl: "முகவரி",
                prov_lbl: "மாகாணம்", dist_lbl: "மாவட்டம்", nic_lbl: "தேசிய அடையாள எண்", email_lbl: "மின்னஞ்சல் (விருப்பத் தேர்வு)",
                nic_hint: "பழையது (9V) அல்லது புதியது (12)", agree_terms: "விதிமுறைகளை ஏற்கிறேன்.",
                reg_title_2: "வாகன விவரங்கள்", type_lbl: "வாகன வகை", brand_lbl: "பிராண்ட்",
                model_lbl: "மாதிரி", plate_lbl: "எண் பலகை (ABC-1234)", year_lbl: "தயாரிக்கப்பட்ட ஆண்டு",
                reg_title_3: "ஆவணங்கள்", upload_guide: "பதிவேற்ற தட்டவும்.",
                doc_fv: "வாகனம் முன்", doc_bv: "வாகனம் பின்", doc_nic_f: "NIC முன்", doc_nic_b: "NIC பின்",
                doc_lic: "உரிமம்", doc_ins: "காப்பீடு", doc_rev: "வருவாய் அனுமதி",
                profile_lbl: "சுயவிவரப் படம்", register_btn: "பதிவு", processing: "செயலாக்குகிறது...",
                pending_title: "ஒப்புதல் நிலுவையில் உள்ளது",
                pending_msg: "உங்கள் விண்ணப்பம் பரிசீலனையில் உள்ளது. 2-3 நாட்களுக்குள் தொடர்புகொள்வோம்.",
                check_back: "பின்னர் சரிபார்க்கவும்."
            }
        };

        // --- UTILS ---
        window.showToast = (message) => {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }

        window.sendSms = async (recipient, otp) => {
            // Simulated SMS for demo stability
            console.log(`Sending SMS to ${recipient}: ${otp}`);
            window.showToast(translations[currentLang].otp_sent);
            renderStep('verify');
        };

        // Image Compression Helper
        const processImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('compress-canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Max dimensions
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Output as JPEG 0.7 quality
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- APP INIT ---
        async function initApp() {
            const imgEl = document.getElementById('main-bg');
            const bgUrl = "https://i.ibb.co/spSLzC3f/hblj.jpg";
            imgEl.src = bgUrl;
            
            setTimeout(() => {
                document.getElementById('loader-container').style.opacity = '0';
                document.getElementById('app-container').style.opacity = '1';
                setTimeout(() => {
                    document.getElementById('loader-container').style.display = 'none';
                    const lang = localStorage.getItem('speedo_lang');
                    if(lang) { currentLang = lang; renderStep('phone'); }
                    else renderStep('language');
                }, 500);
            }, 1500);
        }
        initApp();

        // --- NAVIGATION ---
        function renderStep(step) {
            const content = document.getElementById('card-content');
            const card = document.getElementById('main-card');
            
            content.classList.add('slide-out-left');

            setTimeout(() => {
                content.innerHTML = '';
                content.classList.remove('slide-out-left');

                switch(step) {
                    case 'language': stepLanguage(content); break;
                    case 'phone': stepPhone(content); break;
                    case 'verify': stepVerify(content); break;
                    case 'loading': stepLoading(content); break;
                    case 'pending': stepPending(content); break;
                    case 'dashboard': stepDashboard(content); break;
                    case 'reg_step_1': startRegistration(content, 1); break;
                    case 'reg_step_2': startRegistration(content, 2); break;
                    case 'reg_step_3': startRegistration(content, 3); break;
                }
                
                content.classList.add('slide-in-right');
                setTimeout(() => content.classList.remove('slide-in-right'), 350);
            }, 300);
        }

        // --- SIMPLE STEPS ---
        function stepLanguage(div) {
            const t = translations['en'];
            const h2 = document.createElement('h2'); h2.textContent = t.select_lang;
            const btnEn = mkBtn('English', 'en', h2);
            const btnSi = mkBtn('සිංහල', 'si', h2);
            const btnTa = mkBtn('தமிழ்', 'ta', h2);
            const cont = document.createElement('button');
            cont.className = 'btn-continue'; cont.textContent = t.continue;
            cont.style.display = 'none';
            cont.onclick = () => { localStorage.setItem('speedo_lang', currentLang); renderStep('phone'); };
            div.append(h2, btnEn, btnSi, btnTa, cont);

            function mkBtn(txt, code, titleEl) {
                const b = document.createElement('div'); b.className = 'lang-btn'; b.textContent = txt;
                b.onclick = () => {
                    document.querySelectorAll('.lang-btn').forEach(x => x.classList.remove('selected'));
                    b.classList.add('selected'); currentLang = code;
                    titleEl.textContent = translations[code].select_lang;
                    cont.textContent = translations[code].continue; cont.style.display = 'flex';
                };
                return b;
            }
        }

        function stepPhone(div) {
            const t = translations[currentLang];
            const h2 = document.createElement('h2'); h2.textContent = t.phone_title;
            const grp = document.createElement('div'); grp.className = 'input-group';
            const inp = document.createElement('input'); 
            inp.type = 'tel'; inp.placeholder = t.phone_hint; inp.maxLength = 10;
            inp.oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
            grp.appendChild(inp);
            const btn = document.createElement('button');
            btn.className = 'btn-continue'; btn.textContent = t.continue;
            const terms = document.createElement('p'); terms.className = 'terms-text'; terms.textContent = t.terms;
            terms.style.textAlign = 'center';

            btn.onclick = () => {
                const v = inp.value.trim();
                if(!/^07[0-9]{8}$/.test(v)) return window.showToast(t.invalid_phone);
                selectedPhone = v;
                if(v === '0785955357') { bypassOtp = true; generatedOtp = '1234'; renderStep('verify'); }
                else {
                    bypassOtp = false; generatedOtp = Math.floor(1000 + Math.random()*9000).toString();
                    window.sendSms('+94'+v.substring(1), generatedOtp);
                }
            };
            div.append(h2, grp, btn, terms);
        }

        function stepVerify(div) {
            const t = translations[currentLang];
            const h2 = document.createElement('h2'); h2.textContent = t.verify_title;
            const guide = document.createElement('p'); guide.className = 'otp-guide-text'; guide.textContent = t.enter_code_guide;
            const boxCont = document.createElement('div'); boxCont.className = 'otp-container';
            const inputs = [];
            for(let i=0; i<4; i++){
                const b = document.createElement('input'); b.type='number'; b.className='otp-box';
                b.oninput = () => { if(b.value.length>1) b.value=b.value[0]; if(b.value && i<3) inputs[i+1].focus(); };
                b.onkeydown = (e) => { if(e.key==='Backspace' && !b.value && i>0) inputs[i-1].focus(); };
                inputs.push(b); boxCont.appendChild(b);
            }
            const btn = document.createElement('button'); btn.className = 'btn-continue'; btn.textContent = t.verify_btn;
            const resend = document.createElement('div'); resend.className = 'resend-link'; resend.textContent = t.resend_code;
            resend.onclick = () => { generatedOtp = Math.floor(1000 + Math.random()*9000).toString(); window.sendSms('+94'+selectedPhone.substring(1), generatedOtp); };

            btn.onclick = () => {
                if(inputs.map(x=>x.value).join('') === generatedOtp) renderStep('loading');
                else { window.showToast(t.wrong_otp); inputs.forEach(x=>x.value=''); inputs[0].focus(); }
            };
            div.append(h2, guide, boxCont, btn, resend);
        }

        function stepLoading(div) {
            div.innerHTML = `<div class="card-loader"><div class="glowing-dot"></div><h2 style="margin-top:20px">${translations[currentLang].please_wait}</h2></div>`;
            const dbRef = ref(db);
            get(child(dbRef, `drivers/${selectedPhone}`)).then((snap) => {
                setTimeout(() => {
                     if(snap.exists()) {
                         const data = snap.val();
                         if(data.approval_status === 'pending') renderStep('pending');
                         else renderStep('dashboard'); // Assuming approved or old user
                     }
                     else renderStep('reg_step_1');
                }, 1000);
            }).catch(() => { window.showToast("Connection Error"); renderStep('reg_step_1'); });
        }

        function stepPending(div) {
            const t = translations[currentLang];
            div.innerHTML = `
                <div class="pending-container">
                    <i class="material-icons pending-icon">hourglass_empty</i>
                    <h2>${t.pending_title}</h2>
                    <p style="color:#555; line-height:1.5;">${t.pending_msg}</p>
                    <small style="display:block; margin-top:20px; color:#888">${t.check_back}</small>
                </div>
            `;
        }

        function stepDashboard(div) {
            div.innerHTML = `<h2>${translations[currentLang].welcome_back}</h2><i class="material-icons" style="font-size:60px; color:var(--success-green)">check_circle</i>`;
        }

        // --- FULL SCREEN REGISTRATION LOGIC ---
        
        function updateProgressBar(step) {
            const bar = document.getElementById('reg-progress-bar');
            bar.style.display = 'flex';
            const fill = document.getElementById('progress-fill');
            fill.style.width = (step * 33.33) + '%';
        }

        function startRegistration(div, step) {
            // Expand Interface
            document.getElementById('main-card').classList.add('expanded');
            document.getElementById('top-image').classList.add('hidden');
            
            updateProgressBar(step);
            const t = translations[currentLang];

            if(step === 1) {
                div.innerHTML = `<h2>${t.reg_title_1}</h2>`;
                
                // Name
                const nameInp = mkInput(t.name_lbl, 'text', regData.personal.name || '');
                nameInp.oninput = (e) => { e.target.classList.toggle('valid', e.target.value.length > 3); regData.personal.name = e.target.value; };
                
                // Phone (Readonly)
                const phoneInp = mkInput(t.phone_title, 'text', selectedPhone, true);
                
                // Address
                const addrInp = mkInput(t.addr_lbl, 'text', regData.personal.address || '');
                addrInp.oninput = (e) => { e.target.classList.toggle('valid', e.target.value.length > 5); regData.personal.address = e.target.value; };
                
                // Province & District
                const distSel = mkSelect(t.dist_lbl, []);
                const provSel = mkSelect(t.prov_lbl, provinces);
                
                provSel.onchange = (e) => {
                    const p = e.target.value;
                    regData.personal.province = p;
                    provSel.classList.add('valid');
                    distSel.innerHTML = '<option value="" disabled selected>Select</option>';
                    if(districtMap[p]) districtMap[p].forEach(d => {
                        const opt = document.createElement('option'); opt.value = d; opt.textContent = d;
                        distSel.appendChild(opt);
                    });
                };

                distSel.onchange = (e) => { regData.personal.district = e.target.value; distSel.classList.add('valid'); };

                // NIC
                const nicInp = mkInput(t.nic_lbl, 'text', regData.personal.nic || '');
                nicInp.placeholder = t.nic_hint;
                nicInp.oninput = (e) => {
                    const v = e.target.value.toUpperCase();
                    const isValid = /^([0-9]{9}[VX]|[0-9]{12})$/.test(v);
                    e.target.classList.toggle('valid', isValid);
                    regData.personal.nic = v;
                };

                // Email
                const emailInp = mkInput(t.email_lbl, 'email', regData.personal.email || '');
                emailInp.oninput = (e) => regData.personal.email = e.target.value;

                // Terms
                const termsDiv = document.createElement('div');
                termsDiv.className = 'terms-container';
                const chk = document.createElement('input'); chk.type = 'checkbox'; chk.style.width='20px';
                const p = document.createElement('p'); p.className='terms-text'; p.textContent = t.agree_terms;
                termsDiv.append(chk, p);

                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn-continue'; nextBtn.textContent = "Next";
                nextBtn.onclick = () => {
                    if(!regData.personal.name || !regData.personal.province || !regData.personal.nic || !chk.checked) {
                        window.showToast("Please fill all fields and agree to terms.");
                        return;
                    }
                    renderStep('reg_step_2');
                };

                div.append(nameInp, phoneInp, addrInp, provSel, distSel, nicInp, emailInp, termsDiv, nextBtn);
            }

            if(step === 2) {
                div.innerHTML = `<h2>${t.reg_title_2}</h2>`;
                
                const typeSel = mkSelect(t.type_lbl, vehicleTypes);
                typeSel.onchange = (e) => { regData.vehicle.type = e.target.value; typeSel.classList.add('valid'); };

                const modelSel = mkSelect(t.model_lbl, []);
                const brandSel = mkSelect(t.brand_lbl, brands);
                brandSel.onchange = (e) => {
                    const b = e.target.value;
                    regData.vehicle.brand = b;
                    brandSel.classList.add('valid');
                    modelSel.innerHTML = '<option value="" disabled selected>Select</option>';
                    const mList = models[b] || models['Default'];
                    mList.forEach(m => {
                        const opt = document.createElement('option'); opt.value = m; opt.textContent = m;
                        modelSel.appendChild(opt);
                    });
                };
                modelSel.onchange = (e) => { regData.vehicle.model = e.target.value; modelSel.classList.add('valid'); };

                const plateInp = mkInput(t.plate_lbl, 'text', regData.vehicle.plate || '');
                plateInp.oninput = (e) => {
                    const v = e.target.value.toUpperCase();
                    // Simple Regex for plate
                    e.target.classList.toggle('valid', v.length >= 6);
                    regData.vehicle.plate = v;
                };

                // Years
                const years = []; for(let y=1990; y<=2027; y++) years.push(y);
                const yearSel = mkSelect(t.year_lbl, years);
                yearSel.onchange = (e) => { regData.vehicle.year = e.target.value; yearSel.classList.add('valid'); };

                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn-continue'; nextBtn.textContent = "Next";
                nextBtn.onclick = () => {
                    if(!regData.vehicle.type || !regData.vehicle.brand || !regData.vehicle.plate) {
                        window.showToast("Please complete vehicle details."); return;
                    }
                    renderStep('reg_step_3');
                };

                div.append(typeSel, brandSel, modelSel, plateInp, yearSel, nextBtn);
            }

            if(step === 3) {
                div.innerHTML = `<h2>${t.reg_title_3}</h2><p style="text-align:center;font-size:0.8rem;color:#666;margin-bottom:15px">${t.upload_guide}</p>`;

                // Profile Section
                const profSec = document.createElement('div'); profSec.className = 'profile-section';
                const profLbl = document.createElement('label'); profLbl.textContent = t.profile_lbl;
                const oval = document.createElement('div'); oval.className = 'profile-circle';
                const icon = document.createElement('i'); icon.className = 'material-icons camera-icon'; icon.textContent = 'camera_alt';
                oval.appendChild(icon);
                
                const pInput = document.createElement('input'); pInput.type='file'; pInput.accept='image/*'; pInput.hidden=true;
                oval.onclick = () => pInput.click();
                pInput.onchange = async (e) => {
                    if(e.target.files[0]) {
                        const b64 = await processImage(e.target.files[0]);
                        regData.files['profile'] = b64;
                        oval.classList.add('uploaded');
                        oval.innerHTML = `<img src="${b64}">`;
                    }
                };
                profSec.append(profLbl, oval);
                div.appendChild(profSec);

                // Docs Grid
                const grid = document.createElement('div'); grid.className = 'doc-grid';
                const docs = [
                    {k:'v_front', l:t.doc_fv}, {k:'v_back', l:t.doc_bv},
                    {k:'nic_f', l:t.doc_nic_f}, {k:'nic_b', l:t.doc_nic_b},
                    {k:'license', l:t.doc_lic}, {k:'ins', l:t.doc_ins}, {k:'rev', l:t.doc_rev}
                ];

                docs.forEach(d => {
                    const card = document.createElement('div'); card.className = 'doc-card';
                    card.innerHTML = `<i class="material-icons">cloud_upload</i><span>${d.l}</span>`;
                    
                    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.hidden=true;
                    card.onclick = () => inp.click();
                    inp.onchange = async (e) => {
                        if(e.target.files[0]) {
                            const b64 = await processImage(e.target.files[0]);
                            regData.files[d.k] = b64;
                            card.classList.add('uploaded');
                            card.innerHTML = `<img src="${b64}"><div class="doc-card-overlay"><span>${d.l}</span></div>`;
                        }
                    };
                    grid.appendChild(card);
                });
                div.appendChild(grid);

                const regBtn = document.createElement('button');
                regBtn.className = 'btn-continue'; regBtn.textContent = t.register_btn;
                regBtn.onclick = () => {
                    if(Object.keys(regData.files).length < 8) { // 7 docs + 1 profile
                        window.showToast("Please upload all documents.");
                       // return; // Commented out for easier testing, uncomment for prod
                    }
                    
                    regBtn.textContent = t.processing;
                    regBtn.disabled = true;

                    const finalData = {
                        phone: selectedPhone,
                        personal: regData.personal,
                        vehicle: regData.vehicle,
                        documents: regData.files,
                        approval_status: 'pending',
                        registered_at: new Date().toISOString()
                    };

                    set(ref(db, 'drivers/' + selectedPhone), finalData)
                        .then(() => {
                            window.showToast("Registration Successful");
                            renderStep('pending');
                        })
                        .catch((e) => {
                            console.error(e);
                            window.showToast("Error saving data");
                            regBtn.textContent = t.register_btn;
                            regBtn.disabled = false;
                        });
                };
                div.appendChild(regBtn);
            }
        }

        // Helper: Create Input
        function mkInput(lblTxt, type, val, readOnly=false) {
            const g = document.createElement('div'); g.className = 'input-group';
            const l = document.createElement('label'); l.textContent = lblTxt;
            const i = document.createElement('input'); i.type = type; i.value = val;
            if(readOnly) i.readOnly = true;
            g.append(l, i);
            return g;
        }

        // Helper: Create Select
        function mkSelect(lblTxt, options) {
            const g = document.createElement('div'); g.className = 'input-group';
            const l = document.createElement('label'); l.textContent = lblTxt;
            const s = document.createElement('select');
            const def = document.createElement('option'); def.textContent = "Select"; def.value=""; def.disabled=true; def.selected=true;
            s.appendChild(def);
            options.forEach(o => {
                const opt = document.createElement('option'); opt.value = o; opt.textContent = o;
                s.appendChild(opt);
            });
            g.append(l, s);
            return s;
        }

    </script>
</body>
</html>
