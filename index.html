<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Driver</title>
    <!-- Material Icons CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-red: #ff0000;
            --white: #ffffff;
            --gray-light: #f0f0f0;
            --text-dark: #333333;
            --radius: 15px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--white);
            overflow: hidden;
        }

        /* --- LOADER --- */
        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .glowing-dot {
            width: 20px;
            height: 20px;
            background-color: var(--primary-red);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-red), 0 0 20px var(--primary-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- MAIN LAYOUT --- */
        #app-container {
            opacity: 0; /* Hidden initially for fade-in */
            transition: opacity 0.5s ease;
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        /* Image Section */
        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 75%;
            overflow: hidden;
            z-index: 1;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Bottom Card */
        .bottom-card {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: var(--white);
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            z-index: 10;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Animation Containers */
        #card-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Ensure smooth transitions */
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .slide-out-left {
            transform: translateX(-100%);
            opacity: 0;
        }

        .slide-in-right {
            animation: slideIn 0.4s forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Typography & Elements */
        h2 {
            font-size: 1.2rem;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .lang-btn {
            width: 90%;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            background: white;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }

        .lang-btn.selected {
            border: 2px solid var(--primary-red);
            color: var(--primary-red);
            font-weight: bold;
            background-color: #fff0f0;
        }

        .btn-continue {
            width: 90%;
            padding: 15px;
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            margin-top: auto; 
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-group {
            width: 90%;
            margin-bottom: 10px;
        }

        input[type="tel"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            font-size: 1.1rem;
            outline: none;
        }

        input:focus {
            border-color: var(--primary-red);
        }

        .terms-text {
            font-size: 0.75rem;
            color: #777;
            text-align: center;
            width: 90%;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .otp-container {
            display: flex;
            justify-content: space-between;
            width: 80%;
            margin: 20px 0;
        }

        .otp-box {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #ccc;
            border-radius: var(--radius);
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: var(--radius);
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .card-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>

    <!-- Initial Loading Screen (Red Dot) -->
    <div id="loader-container">
        <div class="glowing-dot"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Main App Structure -->
    <div id="app-container">
        <div class="image-container">
            <!-- Image src assigned in JS to ensure loading control -->
            <img id="main-bg" alt="Background">
        </div>

        <div class="bottom-card">
            <div id="card-content">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDeCmIR6QnvCJWRgBYxgLinxwMIOmJfMxc",
            authDomain: "speedo-main.firebaseapp.com",
            databaseURL: "https://speedo-main-default-rtdb.firebaseio.com",
            projectId: "speedo-main",
            storageBucket: "speedo-main.firebasestorage.app",
            messagingSenderId: "3579467539",
            appId: "1:3579467539:web:5409255e200431edcbece6",
            measurementId: "G-9GTDXQ6E01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let currentLang = 'en';
        let selectedPhone = '';
        let generatedOtp = '';
        let bypassOtp = false;

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                select_lang: "Select a language to continue",
                continue: "Continue",
                phone_title: "Enter your phone number",
                phone_hint: "e.g., 071XXXXXXX",
                invalid_phone: "Invalid phone number. Must be 10 digits starting with 07.",
                terms: "By logging in / registering on SPEEDO DRIVER, you agree to our terms and conditions. Visit SPEEDO website for more info",
                otp_sent: "OTP sent successfully.",
                verify_title: "Verify phone number",
                verify_btn: "Verify",
                wrong_otp: "Incorrect OTP. Please try again.",
                please_wait: "Please Wait...",
                registration: "Registration Form",
                welcome_back: "Welcome Back!"
            },
            si: {
                select_lang: "ඉදිරියට යාමට භාෂාවක් තෝරන්න",
                continue: "ඉදිරියට යන්න",
                phone_title: "ඔබගේ දුරකථන අංකය ඇතුළත් කරන්න",
                phone_hint: "උදා: 071XXXXXXX",
                invalid_phone: "දුරකථන අංකය වලංගු නොවේ. 07 න් ආරම්භ වන ඉලක්කම් 10 ක් විය යුතුය.",
                terms: "SPEEDO DRIVER වෙත පිවිසීමෙන් / ලියාපදිංචි වීමෙන්, ඔබ අපගේ නියමයන් සහ කොන්දේසි වලට එකඟ වේ. වැඩි විස්තර සඳහා SPEEDO වෙබ් අඩවියට පිවිසෙන්න",
                otp_sent: "OTP සාර්ථකව යවන ලදි.",
                verify_title: "දුරකථන අංකය තහවුරු කරන්න",
                verify_btn: "තහවුරු කරන්න",
                wrong_otp: "වැරදි OTP අංකයකි. නැවත උත්සාහ කරන්න.",
                please_wait: "කරුණාකර රැඳී සිටින්න...",
                registration: "ලියාපදිංචි වීමේ පෝරමය",
                welcome_back: "නැවතත් ආයුබෝවන්!"
            },
            ta: {
                select_lang: "தொடர மொழியைத் தேர்ந்தெடுக்கவும்",
                continue: "தொடரவும்",
                phone_title: "உங்கள் தொலைபேசி எண்ணை உள்ளிடவும்",
                phone_hint: "எ.கா. 071XXXXXXX",
                invalid_phone: "தவறான தொலைபேசி எண். 07 இல் தொடங்கும் 10 இலக்கங்களாக இருக்க வேண்டும்.",
                terms: "SPEEDO DRIVER இல் உள்நுழைவதன் / பதிவு செய்வதன் மூலம், எங்கள் விதிமுறைகள் மற்றும் நிபந்தனைகளை ஏற்கிறீர்கள். மேலும் தகவலுக்கு SPEEDO இணையதளத்தைப் பார்வையிடவும்",
                otp_sent: "OTP வெற்றிகரமாக அனுப்பப்பட்டது.",
                verify_title: "தொலைபேசி எண்ணை சரிபார்க்கவும்",
                verify_btn: "சரிபார்க்கவும்",
                wrong_otp: "தவறான OTP. மீண்டும் முயற்சிக்கவும்.",
                please_wait: "காத்திருக்கவும்...",
                registration: "பதிவு படிவம்",
                welcome_back: "மீண்டும் வருக!"
            }
        };

        // --- UTILITIES ---
        window.showToast = (message) => {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- SMS API ---
        window.sendSms = async (recipient, otp) => {
            try {
                let msg = "";
                if(currentLang === 'si') {
                    msg = `ඔබගේ SPEEDO තහවුරු කිරීමේ කේතය ${otp} වේ.`;
                } else if (currentLang === 'ta') {
                    msg = `உங்கள் SPEEDO சரிபார்ப்பு குறியீடு ${otp}.`;
                } else {
                    msg = `Your SPEEDO verification code is ${otp}.`;
                }

                // Call API
                await fetch("https://app.text.lk/api/v3/sms/send", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer 2975|Wz0ile7QSbXVtBMEfs3qrJcFHiz74DOnCkgfnJni36b0e4bc`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: recipient, sender_id: "TextLKDemo", type: "plain", message: msg })
                });
                
                localStorage.setItem('speedo_otp_ts', Date.now().toString());
                window.showToast(translations[currentLang].otp_sent);
                renderStep('verify');
            } catch(e) { 
                console.error(e); 
                window.showToast("SMS Failed. Check Console.");
                // For development safety, still allow verify if API fails? 
                // Uncomment to bypass on error: renderStep('verify');
            }
        };

        // --- APP STARTUP & PRELOADING ---
        // This function ensures Font and Image are loaded before hiding the red dot
        async function initSpeedoApp() {
            const bgImgUrl = "https://i.ibb.co/spSLzC3f/hblj.jpg";
            const imgEl = document.getElementById('main-bg');

            // 1. Image Load Promise
            const imageLoadPromise = new Promise((resolve, reject) => {
                imgEl.onload = () => resolve("Image Loaded");
                imgEl.onerror = () => resolve("Image Failed"); // Resolve anyway to not block app
                imgEl.src = bgImgUrl;
                if (imgEl.complete) resolve("Image Cached");
            });

            // 2. Font Load Promise (Material Icons)
            // Forces the browser to fetch the woff2 file now
            const fontLoadPromise = document.fonts.ready.then(() => {
                // Specifically check if Material Icons is loaded, or wait for it
                if (document.fonts.check('1em "Material Icons"')) {
                    return "Font Loaded";
                } else {
                    return document.fonts.load('1em "Material Icons"');
                }
            });

            // 3. Safety Timeout (5 seconds max)
            const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve("Timeout"), 5000));

            // Wait for resources OR timeout
            await Promise.race([
                Promise.all([imageLoadPromise, fontLoadPromise]),
                timeoutPromise
            ]);

            // Resources ready (or timed out), hide loader
            const loader = document.getElementById('loader-container');
            const appContainer = document.getElementById('app-container');

            loader.style.opacity = '0';
            appContainer.style.display = 'block';
            
            // Allow CSS transition to finish before removing loader from DOM
            setTimeout(() => {
                loader.style.display = 'none';
                appContainer.style.opacity = '1';
                
                // Initialize View
                const storedLang = localStorage.getItem('speedo_lang');
                if(storedLang) {
                    currentLang = storedLang;
                    renderStep('phone');
                } else {
                    renderStep('language');
                }
            }, 500);
        }

        // Start initialization immediately
        initSpeedoApp();


        // --- UI RENDERER ---
        function renderStep(step) {
            const contentDiv = document.getElementById('card-content');
            
            // Slide out current content
            contentDiv.classList.add('slide-out-left');

            setTimeout(() => {
                contentDiv.innerHTML = ''; // Clear
                contentDiv.classList.remove('slide-out-left');
                
                // Render new content
                switch(step) {
                    case 'language': renderLanguageStep(contentDiv); break;
                    case 'phone': renderPhoneStep(contentDiv); break;
                    case 'verify': renderVerifyStep(contentDiv); break;
                    case 'loading': renderLoadingStep(contentDiv); break;
                    case 'registration': renderRegistrationStep(contentDiv); break;
                    case 'dashboard': renderDashboardStep(contentDiv); break;
                }

                // Slide in new content
                contentDiv.classList.add('slide-in-right');
                setTimeout(() => {
                    contentDiv.classList.remove('slide-in-right');
                }, 400);

            }, 300);
        }

        // 1. Language Step
        function renderLanguageStep(container) {
            const t = translations['en'];
            const title = document.createElement('h2');
            title.textContent = t.select_lang;

            const btnEn = createLangButton('English', 'en');
            const btnSi = createLangButton('සිංහල', 'si');
            const btnTa = createLangButton('தமிழ்', 'ta');

            const continueBtn = document.createElement('button');
            continueBtn.className = 'btn-continue';
            continueBtn.textContent = t.continue;
            continueBtn.style.display = 'none';
            continueBtn.onclick = () => {
                localStorage.setItem('speedo_lang', currentLang);
                document.cookie = `speedo_lang=${currentLang}; path=/; max-age=31536000`;
                renderStep('phone');
            };

            container.append(title, btnEn, btnSi, btnTa, continueBtn);

            function createLangButton(text, code) {
                const btn = document.createElement('div');
                btn.className = 'lang-btn';
                btn.textContent = text;
                btn.onclick = () => {
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    currentLang = code;
                    title.textContent = translations[code].select_lang;
                    continueBtn.textContent = translations[code].continue;
                    continueBtn.style.display = 'flex';
                };
                return btn;
            }
        }

        // 2. Phone Step
        function renderPhoneStep(container) {
            const t = translations[currentLang];
            const title = document.createElement('h2');
            title.textContent = t.phone_title;

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            const input = document.createElement('input');
            input.type = 'tel';
            input.placeholder = t.phone_hint;
            input.maxLength = 10;
            input.oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
            inputGroup.appendChild(input);

            const continueBtn = document.createElement('button');
            continueBtn.className = 'btn-continue';
            continueBtn.textContent = t.continue;
            
            const terms = document.createElement('p');
            terms.className = 'terms-text';
            terms.textContent = t.terms;

            continueBtn.onclick = () => {
                const val = input.value.trim();
                const phoneRegex = /^07[0-9]{8}$/; // Starts with 07, total 10 digits
                
                if (!phoneRegex.test(val)) {
                    window.showToast(t.invalid_phone);
                    return;
                }

                selectedPhone = val;
                
                if (val === '0785955357') {
                    bypassOtp = true;
                    generatedOtp = '1234';
                    renderStep('verify');
                } else {
                    bypassOtp = false;
                    generatedOtp = Math.floor(1000 + Math.random() * 9000).toString();
                    const formattedNum = '+94' + val.substring(1);
                    window.sendSms(formattedNum, generatedOtp);
                }
            };

            container.append(title, inputGroup, continueBtn, terms);
        }

        // 3. Verify Step
        function renderVerifyStep(container) {
            const t = translations[currentLang];
            const title = document.createElement('h2');
            title.textContent = t.verify_title;

            const otpDiv = document.createElement('div');
            otpDiv.className = 'otp-container';

            const inputs = [];
            for(let i=0; i<4; i++) {
                const box = document.createElement('input');
                box.type = 'number';
                box.className = 'otp-box';
                box.oninput = () => { if(box.value.length > 1) box.value = box.value.slice(0,1); };
                box.onkeyup = (e) => {
                    if ((e.key >= 0 && e.key <= 9) || e.key === 'Backspace') {
                        if (box.value.length === 1 && i < 3) inputs[i+1].focus();
                        if (e.key === 'Backspace' && i > 0) inputs[i-1].focus();
                    } else if (box.value.length === 1 && i < 3) {
                         // Fallback for mobile tap
                         inputs[i+1].focus();
                    }
                };
                inputs.push(box);
                otpDiv.appendChild(box);
            }

            const verifyBtn = document.createElement('button');
            verifyBtn.className = 'btn-continue';
            verifyBtn.textContent = t.verify_btn;

            verifyBtn.onclick = () => {
                const enteredOtp = inputs.map(i => i.value).join('');
                if (enteredOtp === generatedOtp) {
                    renderStep('loading');
                } else {
                    window.showToast(t.wrong_otp);
                    inputs.forEach(i => i.value = '');
                    inputs[0].focus();
                }
            };

            container.append(title, otpDiv, verifyBtn);
        }

        // 4. Checking DB Loading
        function renderLoadingStep(container) {
            const t = translations[currentLang];
            const loaderWrapper = document.createElement('div');
            loaderWrapper.className = 'card-loader';

            const dot = document.createElement('div');
            dot.className = 'glowing-dot';
            
            const label = document.createElement('h2');
            label.style.marginTop = "20px";
            label.textContent = t.please_wait;

            loaderWrapper.append(dot, label);
            container.appendChild(loaderWrapper);

            checkDatabase();
        }

        async function checkDatabase() {
            // Using phone number as key in 'drivers' node
            const dbRef = ref(db);
            const userId = selectedPhone; 

            try {
                const snapshot = await get(child(dbRef, `drivers/${userId}`));
                if (snapshot.exists()) {
                    renderStep('dashboard');
                } else {
                    renderStep('registration');
                }
            } catch (error) {
                console.error("DB Error:", error);
                window.showToast("Connection Error");
                renderStep('registration'); // Fallback to reg if DB fails? Or retry?
            }
        }

        // 5. New User Registration
        function renderRegistrationStep(container) {
             const t = translations[currentLang];
             const title = document.createElement('h2');
             title.textContent = t.registration;
             title.style.color = 'var(--primary-red)';
             
             const info = document.createElement('p');
             info.textContent = selectedPhone;
             info.style.fontWeight = "bold";

             // Add basic icon to show font is loaded
             const icon = document.createElement('i');
             icon.className = "material-icons";
             icon.textContent = "person_add";
             icon.style.fontSize = "40px";
             icon.style.color = "#ccc";

             container.append(icon, title, info);
        }

        // 6. Existing User Dashboard
        function renderDashboardStep(container) {
             const t = translations[currentLang];
             const title = document.createElement('h2');
             title.textContent = t.welcome_back;
             
             const icon = document.createElement('i');
             icon.className = "material-icons";
             icon.textContent = "check_circle"; // This icon is loaded/cached
             icon.style.color = "var(--primary-red)";
             icon.style.fontSize = "60px";

             container.append(title, icon);
        }

    </script>
</body>
</html>
