--- START OF FILE Paste February 02, 2026 - 10:35AM ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Driver Partner</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;500;700&family=Noto+Sans+Tamil:wght@400;500;700&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Brand Colors */
            --primary-red: #d50000;
            --primary-red-dark: #b71c1c;
            --accent-black: #1a1a1a;
            
            /* Status Colors */
            --success-green: #00c853;
            --warning-amber: #ffab00;
            --error-crimson: #d50000;
            
            /* UI Colors */
            --white: #ffffff;
            --off-white: #f9f9f9;
            --gray-border: #e0e0e0;
            --text-main: #212121;
            --text-sub: #757575;
            
            /* Dimensions */
            --card-radius: 28px; 
            --input-radius: 12px;
            --btn-radius: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000;
            overflow: hidden; 
        }

        /* --- 1. FULL SCREEN LOADER --- */
        #loader-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; display: flex; justify-content: center; align-items: center;
            flex-direction: column; z-index: 10000; transition: opacity 0.5s ease;
        }

        .spinner-box {
            position: relative; width: 80px; height: 80px;
            display: flex; justify-content: center; align-items: center;
        }

        .glowing-dot {
            width: 60px; height: 60px;
            background-color: var(--primary-red);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(213, 0, 0, 0.6);
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        .loader-label {
            margin-top: 25px; font-size: 1rem; color: var(--text-sub);
            letter-spacing: 1px; font-weight: 500; text-transform: uppercase;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0.9); opacity: 1; }
        }

        /* --- 2. PROGRESS BAR --- */
        #reg-progress-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255,255,255,0.95); z-index: 50; display: none; 
            align-items: center; justify-content: center; backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 0 20px;
        }
        .progress-track { width: 100%; max-width: 400px; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-red), #ff5252); width: 0%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }

        /* --- 3. MAIN LAYOUT (IMAGE + BOTTOM SHEET) --- */
        #app-container {
            opacity: 0; transition: opacity 0.6s ease;
            height: 100vh; width: 100vw;
            position: relative;
        }

        .image-container { 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 70%; 
            z-index: 1; 
            background-color: #000;
        }
        
        .image-container.hidden { display: none; }
        
        .image-container img { 
            width: 100%; height: 100%; object-fit: cover; 
            opacity: 0.8; 
        }

        .bottom-card {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background-color: var(--white);
            border-top-left-radius: var(--card-radius); 
            border-top-right-radius: var(--card-radius);
            z-index: 10;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
            height: auto; 
            max-height: 85vh; 
            min-height: 200px;
            display: flex; flex-direction: column;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .bottom-card.expanded { 
            height: 100vh;
            max-height: 100vh;
            border-radius: 0; 
        }

        #card-scroll-area {
            width: 100%; 
            overflow-y: auto; 
            padding: 35px 25px 40px 25px; 
        }
        
        .expanded #card-scroll-area {
            padding-top: 80px; 
            max-width: 600px; margin: 0 auto;
            height: 100%; 
        }

        /* --- 4. ANIMATIONS --- */
        .slide-out-left { animation: slideOutLeft 0.3s forwards; }
        .slide-in-right { animation: slideInRight 0.3s forwards; }
        @keyframes slideInRight { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-30px); opacity: 0; } }

        /* --- 5. UI ELEMENTS --- */
        h2 { 
            font-size: 1.4rem; color: var(--accent-black); text-align: center; 
            margin: 0 0 15px 0; font-weight: 800; letter-spacing: -0.5px; 
        }
        
        p { color: var(--text-sub); line-height: 1.5; margin-bottom: 20px; text-align: center; font-size: 0.95rem; }

        .lang-btn { 
            width: 100%; padding: 16px; margin-bottom: 10px; 
            border: 1px solid var(--gray-border); border-radius: var(--btn-radius); 
            background: white; font-size: 1rem; cursor: pointer; text-align: center; 
            font-weight: 500; transition: all 0.2s; position: relative; overflow: hidden;
        }
        .lang-btn.selected { 
            border: 2px solid var(--primary-red); color: var(--primary-red); 
            background-color: #ffebee; font-weight: 700; 
        }
        
        .btn-continue { 
            width: 100%; padding: 16px; background-color: var(--primary-red); color: white; 
            border: none; border-radius: var(--btn-radius); font-size: 1.1rem; margin-top: 20px; 
            cursor: pointer; font-weight: 700; letter-spacing: 0.5px;
            box-shadow: 0 6px 20px rgba(213, 0, 0, 0.3); transition: transform 0.2s;
        }
        .btn-continue:active { transform: scale(0.97); }

        .input-group { width: 100%; margin-bottom: 18px; text-align: left; }
        .input-group label { 
            display: block; margin-bottom: 6px; font-size: 0.8rem; 
            color: var(--text-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        input, select { 
            width: 100%; padding: 14px; border: 1px solid var(--gray-border); border-radius: var(--input-radius); 
            font-size: 1.05rem; outline: none; background: #fff; color: var(--text-main);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary-red); box-shadow: 0 0 0 4px rgba(213, 0, 0, 0.1); }

        /* --- 6. WELCOME / APPROVED SCREEN --- */
        .welcome-wrapper {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--white);
            z-index: 5000; overflow-y: auto;
        }

        .welcome-hero-section {
            background: linear-gradient(135deg, #b71c1c 0%, #d50000 100%);
            color: white; padding: 60px 20px 40px 20px;
            text-align: center; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 10px 30px rgba(213, 0, 0, 0.3);
        }

        .welcome-icon-lg { font-size: 60px; margin-bottom: 15px; color: #fff; }
        .welcome-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 10px; line-height: 1.2; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; font-weight: 400; max-width: 400px; margin: 0 auto; }

        .welcome-content { padding: 30px 20px; max-width: 600px; margin: 0 auto; }

        .info-card {
            background: white; border: 1px solid #eee; border-radius: 16px;
            padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        
        .section-header {
            font-size: 1.1rem; font-weight: 800; color: var(--accent-black);
            margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }
        .section-header i { color: var(--primary-red); }

        .gig-highlight {
            background: #fff8e1; border: 1px solid #ffecb3;
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
            display: flex; gap: 15px; align-items: center;
        }
        .gig-icon { 
            width: 40px; height: 40px; background: #ffc107; color: #000; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;
        }

        .rule-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .rule-num { font-size: 1.5rem; font-weight: 900; color: #e0e0e0; line-height: 1; }
        .rule-text h4 { margin: 0 0 5px 0; font-weight: 700; color: var(--text-main); }
        .rule-text p { margin: 0; font-size: 0.9rem; color: var(--text-sub); text-align: left; }

        .welcome-footer {
            padding: 30px; text-align: center; background: #fafafa; border-top: 1px solid #eee;
        }
        .welcome-footer a { color: var(--primary-red); text-decoration: none; font-weight: 600; font-size: 0.9rem; margin: 0 10px; }

        /* --- 7. DOC UPLOAD STYLES --- */
        .doc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; margin-bottom: 25px; }
        .doc-box {
            background: #f5f5f5; border: 2px dashed #cfcfcf; border-radius: 12px;
            height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden; transition: all 0.2s; cursor: pointer;
        }
        .doc-box.done { background: #e8f5e9; border: 2px solid var(--success-green); }
        .doc-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 1; }
        .doc-label { font-size: 0.75rem; color: #666; font-weight: 600; text-align: center; z-index: 2; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; }
        
        .profile-section { text-align: center; margin-bottom: 20px; }
        .profile-circle { 
            width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0; margin: 0 auto; 
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
            border: 2px dashed #ccc; cursor: pointer;
        }
        .profile-circle.done { border: 2px solid var(--success-green); }
        .profile-circle img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; }
        .camera-icon { color: #888; font-size: 30px; }

        /* --- 8. TOAST --- */
        #toast { 
            visibility: hidden; min-width: 280px; background-color: #212121; color: #fff; 
            text-align: center; border-radius: 50px; padding: 16px 24px; position: fixed; 
            z-index: 11000; left: 50%; bottom: 30px; transform: translateX(-50%); 
            font-size: 0.9rem; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 30px; }

        .hidden { display: none !important; }

        /* Status Screens */
        .status-wrapper { padding: 10px 20px; text-align: center; }
        .status-icon-main { font-size: 70px; margin-bottom: 15px; }
        .status-pending { color: var(--warning-amber); animation: pulse 2s infinite; }
        .status-error { color: var(--error-crimson); }
        .status-msg-box { background: #f5f5f5; padding: 20px; border-radius: 12px; margin-top: 20px; text-align: left; }
    </style>
</head>
<body>

    <div id="loader-container">
        <div class="spinner-box">
            <div class="glowing-dot"></div>
        </div>
        <div class="loader-label">Speedo Driver</div>
    </div>

    <div id="reg-progress-bar">
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <div id="toast"></div>

    <div id="app-container">
        <div class="image-container" id="top-image">
            <img src="https://i.ibb.co/spSLzC3f/hblj.jpg" alt="Speedo Driver Background">
        </div>

        <div class="bottom-card" id="main-card">
            <div id="card-scroll-area"></div>
        </div>
    </div>

    <canvas id="compress-canvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, get, child, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDeCmIR6QnvCJWRgBYxgLinxwMIOmJfMxc",
            authDomain: "speedo-main.firebaseapp.com",
            databaseURL: "https://speedo-main-default-rtdb.firebaseio.com",
            projectId: "speedo-main",
            storageBucket: "speedo-main.firebasestorage.app",
            messagingSenderId: "3579467539",
            appId: "1:3579467539:web:5409255e200431edcbece6",
            measurementId: "G-9GTDXQ6E01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentLang = 'en';
        let selectedPhone = '';
        let generatedOtp = '';
        let regData = { personal: {}, vehicle: {}, files: {} };

        const getUid = () => `SPEEDO_D_${selectedPhone}`;

        const provinces = ["Western", "Central", "Southern", "Northern", "Eastern", "North Western", "North Central", "Uva", "Sabaragamuwa"];
        const districtMap = {
            "Western": ["Colombo", "Gampaha", "Kalutara"],
            "Central": ["Kandy", "Matale", "Nuwara Eliya"],
            "Southern": ["Galle", "Matara", "Hambantota"],
            "North Western": ["Kurunegala", "Puttalam"],
            "Northern": ["Jaffna", "Kilinochchi", "Mannar"],
            "Eastern": ["Batticaloa", "Ampara", "Trincomalee"],
            "North Central": ["Anuradhapura", "Polonnaruwa"],
            "Uva": ["Badulla", "Monaragala"],
            "Sabaragamuwa": ["Ratnapura", "Kegalle"]
        };

        const vehicleData = {
            "Bike": {
                "Honda": ["Dio", "Hornet", "Grazia", "Activa", "Click", "PCX", "CBR"],
                "Yamaha": ["FZ", "Ray ZR", "Fascino", "TW 200", "MT-15"],
                "Bajaj": ["Pulsar 150", "Pulsar 135", "CT 100", "Platina", "Discover", "Boxer"],
                "TVS": ["Ntorq", "Apache", "Scooty Pep", "Wego", "Stryker"],
                "Hero": ["Splendor", "Pleasure", "Hunk"]
            },
            "Tuk Tuk": {
                "Bajaj": ["RE 4S", "RE 2 Stroke", "RE Compact", "Maxima"],
                "TVS": ["King"],
                "Piaggio": ["Ape City", "Ape Xtra"]
            },
            "Nano / Mini": {
                "Suzuki": ["Alto", "Spacia", "WagonR", "Stingray", "Celerio", "Hustler", "Every"],
                "Micro": ["Panda", "Panda Cross"],
                "Daihatsu": ["Mira", "Move"],
                "Kia": ["Picanto"]
            },
            "Car": {
                "Toyota": ["Axio", "Prius", "Vitz", "Allion", "Premio", "Yaris", "Aqua", "Corolla 141", "Corolla 121"],
                "Honda": ["Fit GP5", "Fit GP1", "Grace", "Civic", "Vezel", "Insight", "Shuttle", "Freed"],
                "Nissan": ["Leaf", "Sunny", "March", "Tiida", "Sylphy"],
                "Suzuki": ["Swift", "Baleno", "Ciaz"],
                "Hyundai": ["Elantra", "Grand i10"],
                "Kia": ["Rio", "Cerato"]
            },
            "Van": {
                "Toyota": ["KDH 200", "HiAce Dolphin", "TownAce", "Noah", "Voxy"],
                "Nissan": ["Caravan", "Vanette", "NV200"],
                "Mazda": ["Bongo"]
            }
        };

        const translations = {
            en: {
                select_lang: "Select Your Language", continue: "Continue", phone_title: "Enter Mobile Number", phone_hint: "07XXXXXXXX",
                invalid_phone: "Please enter a valid 10-digit number", otp_sent: "OTP Sent Successfully", verify_title: "Verify Your Number", verify_sub: "We sent a 4-digit code to your phone",
                verify_btn: "Verify & Proceed", wrong_otp: "Incorrect Code. Please try again.", resend: "Resend Code",
                step_1_title: "About You", name_lbl: "Full Name", addr_lbl: "Home Address", nic_lbl: "NIC Number", email_lbl: "Email (Optional)",
                prov_lbl: "Province", dist_lbl: "District", terms_txt: "I agree to Speedo's Terms of Service",
                step_2_title: "Your Vehicle", type_lbl: "Vehicle Type", brand_lbl: "Brand", model_lbl: "Model", plate_lbl: "Plate Number (WP ABC-1234)", year_lbl: "Year of Manufacture",
                step_3_title: "Documents", doc_guide: "Tap squares to upload clear photos", d_pf: "Profile Photo", d_vf: "Vehicle Front", d_vb: "Vehicle Back",
                d_nf: "NIC Front", d_nb: "NIC Back", d_dl: "Driving License", d_in: "Insurance", d_rl: "Revenue License",
                submit_btn: "Submit Application", uploading: "Uploading securely...", please_wait: "Checking Status...",
                status_pending_t: "Application Pending", status_pending_d: "We are reviewing your details. This usually takes 24 hours. We will SMS you once active.",
                status_declined_t: "Application Declined", status_retry: "Update & Resubmit", reason_lbl: "Reason:",
                w_title: "Welcome to Speedo Driver Community!", w_sub: "Important: Do NOT uninstall this app. We will notify you via SMS when service starts in your city.",
                sec_1_t: "What is Speedo?", sec_1_d: "Speedo is a 'Gig-Based' platform. Unlike Uber or PickMe, YOU set the price. You negotiate directly with passengers.",
                sec_2_t: "Why Speedo?", gig_1: "Name Your Price", gig_2: "0% Commission",
                fee_t: "Simple Pricing", fee_v: "100 LKR", fee_l: "Daily Access Fee", fee_d: "Only pay on days you work. Keep 100% of your ride earnings.",
                rule_t: "Driver Guidelines", r1_t: "Negotiation", r1_d: "Be fair with your pricing to win more rides.",
                r2_t: "Hygiene", r2_d: "Clean cars get 5-star ratings and more requests.", r3_t: "Safety", r3_d: "Follow traffic rules. Passenger safety is priority.",
                links_web: "Visit Website", links_priv: "Privacy Policy"
            },
            si: {
                select_lang: "භාෂාවක් තෝරන්න", continue: "ඉදිරියට යන්න", phone_title: "දුරකථන අංකය", phone_hint: "07XXXXXXXX",
                invalid_phone: "නිවැරදි දුරකථන අංකයක් ඇතුළත් කරන්න", otp_sent: "OTP යවන ලදි", verify_title: "අංකය තහවුරු කරන්න",
                verify_sub: "ඔබේ දුරකථනයට ලැබුණු කේතය ඇතුලත් කරන්න", verify_btn: "තහවුරු කරන්න", wrong_otp: "වැරදි කේතයකි", resend: "නැවත එවන්න",
                step_1_title: "ඔබේ විස්තර", name_lbl: "සම්පූර්ණ නම", addr_lbl: "ලිපිනය", nic_lbl: "ජා. හැ. අංකය", email_lbl: "විද්‍යුත් තැපෑල",
                prov_lbl: "පළාත", dist_lbl: "දිස්ත්‍රික්කය", terms_txt: "මම නියමයන්ට එකඟ වෙමි",
                step_2_title: "වාහන විස්තර", type_lbl: "වර්ගය", brand_lbl: "වෙළඳ නාමය", model_lbl: "මාදිලිය", plate_lbl: "ලියාපදිංචි අංකය", year_lbl: "වර්ෂය",
                step_3_title: "ලේඛන", doc_guide: "පැහැදිලි ඡායාරූප උඩුගත කරන්න", d_pf: "ඔබේ ඡායාරූපය", d_vf: "වාහනය ඉදිරිපස", d_vb: "වාහනය පිටුපස",
                d_nf: "ජා.හැ. ඉදිරිපස", d_nb: "ජා.හැ. පිටුපස", d_dl: "රියදුරු බලපත්‍රය", d_in: "රක්ෂණ සහතිකය", d_rl: "ආදායම් බලපත්‍රය",
                submit_btn: "ලියාපදිංචි වන්න", uploading: "සකසමින් පවතී...", please_wait: "කරුණාකර රැඳී සිටින්න...",
                status_pending_t: "අනුමැතිය අපේක්ෂාවෙන්", status_pending_d: "ඔබේ අයදුම්පත පරීක්ෂා කරමින් පවතී. අනුමත වූ පසු අපි ඔබට SMS එවන්නෙමු.",
                status_declined_t: "ප්‍රතික්ෂේප විය", status_retry: "නැවත උත්සාහ කරන්න", reason_lbl: "හේතුව:",
                w_title: "SPEEDO පවුලට සාදරයෙන් පිළිගනිමු!", w_sub: "මෙම ඇප් එක ඉවත් (Uninstall) නොකරන්න. සේවාව ආරම්භ කළ විගස අපි ඔබට දැනුම් දෙන්නෙමු.",
                sec_1_t: "Speedo කියන්නේ මොකක්ද?", sec_1_d: "මෙය 'Gig' සේවාවක්. ගාස්තුව තීරණය කරන්නේ ඔබයි. මගියා සමඟ කෙලින්ම ගනුදෙනු කරන්න.",
                sec_2_t: "විශේෂත්ව", gig_1: "ඔබේ ගාස්තුව", gig_2: "0% කොමිස්",
                fee_t: "ගාස්තු ක්‍රමය", fee_v: "රු. 100", fee_l: "දෛනික ගාස්තුව", fee_d: "වැඩ කරන දවස් වලට පමණයි. හයර් එකේ සම්පූර්ණ මුදල ඔබට.",
                rule_t: "උපදෙස්", r1_t: "ගාස්තු", r1_d: "සාධාරණ ගාස්තු අය කරන්න.", r2_t: "පිරිසිදුකම", r2_d: "වාහනය පිරිසිදුව තබාගන්න.", r3_t: "ආරක්ෂාව", r3_d: "පරිස්සමින් රිය පදවන්න.",
                links_web: "වෙබ් අඩවිය", links_priv: "රහස්‍යතා ප්‍රතිපත්තිය"
            },
            ta: {
                select_lang: "மொழியைத் தேர்ந்தெடுக்கவும்", continue: "தொடரவும்", phone_title: "தொலைபேசி எண்", phone_hint: "07XXXXXXXX",
                invalid_phone: "சரியான எண்ணை உள்ளிடவும்", otp_sent: "OTP அனுப்பப்பட்டது", verify_title: "சரிபார்க்கவும்",
                verify_sub: "குறியீட்டை உள்ளிடவும்", verify_btn: "சரிபார்க்கவும்", wrong_otp: "தவறான குறியீடு", resend: "மீண்டும் அனுப்பு",
                step_1_title: "தனிப்பட்ட விவரங்கள்", name_lbl: "முழு பெயர்", addr_lbl: "முகவரி", nic_lbl: "தேசிய அடையாள எண்", email_lbl: "மின்னஞ்சல்",
                prov_lbl: "மாகாணம்", dist_lbl: "மாவட்டம்", terms_txt: "விதிமுறைகளை ஏற்கிறேன்",
                step_2_title: "வாகன விவரங்கள்", type_lbl: "வகை", brand_lbl: "பிராண்ட்", model_lbl: "மாதிரி", plate_lbl: "எண் பலகை", year_lbl: "ஆண்டு",
                step_3_title: "ஆவணங்கள்", doc_guide: "புகைப்படங்களை பதிவேற்றவும்", d_pf: "சுயவிவரப் படம்", d_vf: "வாகனம் முன்", d_vb: "வாகனம் பின்",
                d_nf: "NIC முன்", d_nb: "NIC பின்", d_dl: "உரிமம்", d_in: "காப்பீடு", d_rl: "வருவாய் அனுமதி",
                submit_btn: "பதிவு செய்யவும்", uploading: "பதிவேற்றப்படுகிறது...", please_wait: "காத்திருக்கவும்...",
                status_pending_t: "நிலுவையில் உள்ளது", status_pending_d: "நாங்கள் சரிபார்க்கிறோம். விரைவில் அறிவிப்போம்.",
                status_declined_t: "நிராகரிக்கப்பட்டது", status_retry: "மீண்டும் முயற்சிக்கவும்", reason_lbl: "காரணம்:",
                w_title: "SPEEDO வரவேற்கிறோம்!", w_sub: "செயலியை நீக்க வேண்டாம். சேவை தொடங்கும்போது அறிவிப்போம்.",
                sec_1_t: "Speedo என்றால் என்ன?", sec_1_d: "விலையை நீங்களே தீர்மானிக்கலாம். பயணிகளுடன் நேரடியாக பேசுங்கள்.",
                sec_2_t: "சிறப்பு", gig_1: "உங்கள் விலை", gig_2: "0% கமிஷன்",
                fee_t: "கட்டணம்", fee_v: "100 LKR", fee_l: "தினசரி கட்டணம்", fee_d: "முழு வருமானமும் உங்களுக்கே.",
                rule_t: "விதிகள்", r1_t: "விலை", r1_d: "நியாயமான விலை.", r2_t: "சுத்தம்", r2_d: "வாகனத்தை சுத்தமாக வையுங்கள்.", r3_t: "பாதுகாப்பு", r3_d: "பாதுகாப்பாக ஓட்டவும்.",
                links_web: "இணையதளம்", links_priv: "தனியுரிமை"
            }
        };

        const toggleLoader = (show) => {
            const el = document.getElementById('loader-container');
            if(show) { el.style.display = 'flex'; setTimeout(() => el.style.opacity = '1', 10); } 
            else { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 500); }
        };

        window.showToast = (msg) => {
            const x = document.getElementById("toast");
            x.textContent = msg; x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        };

        window.sendSms = async (phone, otp) => {
            try {
                let formatted = phone;
                if(phone.startsWith('0')) formatted = '94' + phone.substring(1);
                const msg = `Speedo Driver Verification Code: ${otp}`;
                const response = await fetch("https://app.text.lk/api/v3/sms/send", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer 2975|Wz0ile7QSbXVtBMEfs3qrJcFHiz74DOnCkgfnJni36b0e4bc`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient: formatted, sender_id: "TextLKDemo", type: "plain", message: msg })
                });
                if(response.ok) window.showToast(translations[currentLang].otp_sent);
            } catch (e) {
                console.log(`[DEV MODE] OTP IS: ${otp}`);
            }
            renderStep('verify');
        };

        const processImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('compress-canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX = 800;
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        async function initApp() {
            const savedData = localStorage.getItem('speedo_driver_data');
            const savedLang = localStorage.getItem('speedo_lang');
            if(savedLang) currentLang = savedLang;
            setTimeout(() => {
                document.getElementById('app-container').style.opacity = '1';
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        selectedPhone = data.phone;
                        syncStatus().then(d => routeUser(d || data));
                    } catch(e) { renderStep('language'); toggleLoader(false); }
                } else {
                    renderStep(savedLang ? 'phone' : 'language');
                    toggleLoader(false);
                }
            }, 1200);
        }

        async function syncStatus() {
            if(!selectedPhone) return null;
            try {
                const snap = await get(child(ref(db), `drivers/${getUid()}`));
                if(snap.exists()) {
                    localStorage.setItem('speedo_driver_data', JSON.stringify(snap.val()));
                    return snap.val();
                }
            } catch(e) {}
            return null;
        }

        function routeUser(data) {
            if(data.approval_status === 'approved') renderStep('welcome', data);
            else if(data.approval_status === 'declined') renderStep('declined', data);
            else renderStep('pending');
            toggleLoader(false);
        }

        initApp();

        function renderStep(step, data = null) {
            const content = document.getElementById('card-scroll-area');
            const card = document.getElementById('main-card');
            const overlay = document.querySelector('.welcome-wrapper');
            if(overlay) overlay.remove();

            if(step === 'welcome') { stepWelcome(data); return; }
            if(step.startsWith('reg_')) {
                card.classList.add('expanded');
                document.getElementById('top-image').classList.add('hidden');
            } else {
                card.classList.remove('expanded');
                document.getElementById('top-image').classList.remove('hidden');
            }

            content.classList.add('slide-out-left');
            setTimeout(() => {
                content.innerHTML = '';
                content.classList.remove('slide-out-left');
                switch(step) {
                    case 'language': stepLanguage(content); break;
                    case 'phone': stepPhone(content); break;
                    case 'verify': stepVerify(content); break;
                    case 'loading': stepLoading(content); break;
                    case 'pending': stepPending(content); break;
                    case 'declined': stepDeclined(content, data); break;
                    case 'reg_step_1': startRegistration(content, 1); break;
                    case 'reg_step_2': startRegistration(content, 2); break;
                    case 'reg_step_3': startRegistration(content, 3); break;
                }
                content.classList.add('slide-in-right');
            }, 300);
        }

        function stepLanguage(div) {
            const t = translations['en'];
            div.innerHTML = `<h2>${t.select_lang}</h2>`;
            const btnEn = mkBtn('English (US)', 'en');
            const btnSi = mkBtn('සිංහල (Sinhala)', 'si');
            const btnTa = mkBtn('தமிழ் (Tamil)', 'ta');
            const cont = document.createElement('button');
            cont.className = 'btn-continue'; cont.textContent = t.continue; cont.style.display = 'none';
            cont.onclick = () => { localStorage.setItem('speedo_lang', currentLang); renderStep('phone'); };
            div.append(btnEn, btnSi, btnTa, cont);
            function mkBtn(txt, code) {
                const b = document.createElement('div'); b.className = 'lang-btn'; b.textContent = txt;
                b.onclick = () => {
                    document.querySelectorAll('.lang-btn').forEach(x => x.classList.remove('selected'));
                    b.classList.add('selected'); currentLang = code;
                    div.querySelector('h2').textContent = translations[code].select_lang;
                    cont.textContent = translations[code].continue; cont.style.display = 'flex';
                };
                return b;
            }
        }

        function stepPhone(div) {
            const t = translations[currentLang];
            div.innerHTML = `<h2>${t.phone_title}</h2>`;
            const grp = mkInput(t.phone_title, 'tel', '', false);
            const inp = grp.querySelector('input'); inp.placeholder = t.phone_hint; inp.maxLength = 10;
            const btn = document.createElement('button'); btn.className = 'btn-continue'; btn.textContent = t.continue;
            btn.onclick = () => {
                const v = inp.value.trim();
                if(!/^07[0-9]{8}$/.test(v)) return window.showToast(t.invalid_phone);
                selectedPhone = v;
                generatedOtp = Math.floor(1000 + Math.random()*9000).toString(); 
                window.sendSms(selectedPhone, generatedOtp);
            };
            div.append(grp, btn);
        }

        function stepVerify(div) {
            const t = translations[currentLang];
            div.innerHTML = `<h2>${t.verify_title}</h2><p>${t.verify_sub} <b>${selectedPhone}</b></p>`;
            const boxCont = document.createElement('div'); boxCont.style.cssText = "display:flex; gap:12px; margin:20px 0; justify-content:center;";
            const inputs = [];
            for(let i=0; i<4; i++){
                const b = document.createElement('input'); b.type='tel'; b.maxLength=1; 
                b.style.cssText = "width:50px; height:50px; text-align:center; font-size:1.5rem; border-radius:12px; border:2px solid #ddd;";
                b.oninput = () => { if(b.value.length >= 1 && i < 3) inputs[i+1].focus(); };
                inputs.push(b); boxCont.appendChild(b);
            }
            const btn = document.createElement('button'); btn.className = 'btn-continue'; btn.textContent = t.verify_btn;
            btn.onclick = () => {
                if(inputs.map(x=>x.value).join('') === generatedOtp) renderStep('loading');
                else { window.showToast(t.wrong_otp); inputs.forEach(x=>x.value=''); inputs[0].focus(); }
            };
            div.append(boxCont, btn);
        }

        function stepLoading(div) {
            div.innerHTML = `<div style="padding:20px; text-align:center;"><div class="glowing-dot" style="margin:0 auto"></div><p style="margin-top:30px">${translations[currentLang].please_wait}</p></div>`;
            get(child(ref(db), `drivers/${getUid()}`)).then((snap) => {
                if(snap.exists()) routeUser(snap.val());
                else renderStep('reg_step_1');
            }).catch(() => renderStep('reg_step_1'));
        }

        function startRegistration(div, step) {
            document.getElementById('reg-progress-bar').style.display = 'flex';
            document.getElementById('progress-fill').style.width = (step * 33.33) + '%';
            const t = translations[currentLang];

            if(step === 1) {
                div.innerHTML = `<h2>${t.step_1_title}</h2>`;
                const n = mkInput(t.name_lbl, 'text', regData.personal.name);
                const a = mkInput(t.addr_lbl, 'text', regData.personal.address);
                const nic = mkInput(t.nic_lbl, 'text', regData.personal.nic);
                const provSel = mkSelect(t.prov_lbl, provinces);
                const distSel = mkSelect(t.dist_lbl, []);
                provSel.querySelector('select').onchange = (e) => {
                    const ds = distSel.querySelector('select'); ds.innerHTML = '<option value="" disabled selected>Select</option>';
                    (districtMap[e.target.value] || []).forEach(d => ds.innerHTML+=`<option value="${d}">${d}</option>`);
                    regData.personal.province = e.target.value;
                };
                distSel.querySelector('select').onchange = (e) => regData.personal.district = e.target.value;
                const btn = document.createElement('button'); btn.className = 'btn-continue'; btn.textContent = t.continue;
                btn.onclick = () => {
                    regData.personal.name = n.querySelector('input').value;
                    regData.personal.nic = nic.querySelector('input').value;
                    regData.personal.address = a.querySelector('input').value;
                    if(regData.personal.name && regData.personal.nic) renderStep('reg_step_2');
                    else window.showToast("Please fill all details");
                };
                div.append(n, a, nic, provSel, distSel, btn);
            }

            if(step === 2) {
                div.innerHTML = `<h2>${t.step_2_title}</h2>`;
                const typeS = mkSelect(t.type_lbl, Object.keys(vehicleData));
                const brandS = mkSelect(t.brand_lbl, []);
                const modelS = mkSelect(t.model_lbl, []);
                const plate = mkInput(t.plate_lbl, 'text', regData.vehicle.plate);
                typeS.querySelector('select').onchange = (e) => {
                    const bs = brandS.querySelector('select'); bs.innerHTML = '<option value="" disabled selected>Select</option>';
                    Object.keys(vehicleData[e.target.value]).forEach(b => bs.innerHTML+=`<option value="${b}">${b}</option>`);
                    regData.vehicle.type = e.target.value;
                };
                brandS.querySelector('select').onchange = (e) => {
                    const ms = modelS.querySelector('select'); ms.innerHTML = '<option value="" disabled selected>Select</option>';
                    vehicleData[regData.vehicle.type][e.target.value].forEach(m => ms.innerHTML+=`<option value="${m}">${m}</option>`);
                    regData.vehicle.brand = e.target.value;
                };
                modelS.querySelector('select').onchange = (e) => regData.vehicle.model = e.target.value;
                const btn = document.createElement('button'); btn.className = 'btn-continue'; btn.textContent = t.continue;
                btn.onclick = () => {
                    regData.vehicle.plate = plate.querySelector('input').value;
                    if(regData.vehicle.model && regData.vehicle.plate) renderStep('reg_step_3');
                    else window.showToast("Complete vehicle details");
                };
                div.append(typeS, brandS, modelS, plate, btn);
            }

            if(step === 3) {
                div.innerHTML = `<h2>${t.step_3_title}</h2><p>${t.doc_guide}</p>`;
                const profDiv = document.createElement('div'); profDiv.className = 'profile-section';
                profDiv.innerHTML = `<label>${t.d_pf}</label><div class="profile-circle" id="upl-profile"><i class="material-icons camera-icon">camera_alt</i></div>`;
                div.appendChild(profDiv);
                setupUpload(profDiv.querySelector('#upl-profile'), 'profile');

                const grid = document.createElement('div'); grid.className = 'doc-grid';
                const docs = [['v_front', t.d_vf], ['v_back', t.d_vb], ['nic_f', t.d_nf], ['nic_b', t.d_nb], ['license', t.d_dl], ['ins', t.d_in], ['rev', t.d_rl]];
                docs.forEach(([k, l]) => {
                    const box = document.createElement('div'); box.className = 'doc-box'; box.id = `upl-${k}`;
                    box.innerHTML = `<i class="material-icons">add_a_photo</i><div class="doc-label">${l}</div>`;
                    grid.appendChild(box);
                    setupUpload(box, k);
                });
                div.appendChild(grid);
                const btn = document.createElement('button'); btn.className = 'btn-continue'; btn.textContent = t.submit_btn;
                btn.onclick = submitRegistration;
                div.appendChild(btn);
            }

            function setupUpload(el, key) {
                // Create the file input once and keep it
                const inp = document.createElement('input'); 
                inp.type = 'file'; inp.accept = 'image/*'; inp.style.display = 'none';
                el.appendChild(inp);

                // Clicking the container clicks the input
                el.addEventListener('click', (e) => {
                    if (e.target !== inp) inp.click();
                });

                inp.onchange = async (e) => {
                    if (e.target.files[0]) {
                        // Keep the icons/labels but show we're processing
                        const originalHtml = el.innerHTML;
                        const b64 = await processImage(e.target.files[0]);
                        regData.files[key] = b64;
                        
                        // Clear background but keep input
                        const existingImg = el.querySelector('img');
                        if(existingImg) existingImg.remove();
                        
                        const img = document.createElement('img');
                        img.src = b64;
                        el.appendChild(img);
                        el.classList.add('done');
                    }
                };
            }
        }

        async function submitRegistration() {
            if(!regData.files.profile) return window.showToast("Profile Photo Required");
            toggleLoader(true);
            const finalData = { phone: selectedPhone, personal: regData.personal, vehicle: regData.vehicle, documents: regData.files, approval_status: 'pending', registered_at: new Date().toISOString() };
            try {
                await set(ref(db, `drivers/${getUid()}`), finalData);
                localStorage.setItem('speedo_driver_data', JSON.stringify(finalData));
                toggleLoader(false); renderStep('pending');
            } catch(e) { toggleLoader(false); window.showToast("Error. Try again."); }
        }

        function stepPending(div) {
            const t = translations[currentLang];
            div.innerHTML = `<div class="status-wrapper"><i class="material-icons status-icon-main status-pending">hourglass_full</i><h2>${t.status_pending_t}</h2><p>${t.status_pending_d}</p><button class="btn-continue" style="background:#757575;" onclick="location.reload()">Refresh Status</button></div>`;
        }

        function stepDeclined(div, data) {
            const t = translations[currentLang];
            div.innerHTML = `<div class="status-wrapper"><i class="material-icons status-icon-main status-error">highlight_off</i><h2>${t.status_declined_t}</h2><div class="status-msg-box"><strong>${t.reason_lbl}</strong><p>${data.reasons || "Verification Failed"}</p></div><button class="btn-continue" id="resetBtn">${t.status_retry}</button></div>`;
            div.querySelector('#resetBtn').onclick = () => { remove(ref(db, `drivers/${getUid()}`)); localStorage.removeItem('speedo_driver_data'); location.reload(); };
        }

        function stepWelcome(data) {
            const t = translations[currentLang];
            const overlay = document.createElement('div'); overlay.className = 'welcome-wrapper';
            overlay.innerHTML = `<div class="welcome-card"><div class="welcome-hero-section"><i class="material-icons welcome-icon-lg">check_circle</i><div class="welcome-title">${t.w_title}</div><div class="welcome-subtitle">${t.w_sub}</div></div><div class="welcome-content"><div class="info-card"><div class="section-header"><i class="material-icons">info</i> ${t.sec_1_t}</div><p>${t.sec_1_d}</p></div><div class="gig-highlight"><div class="gig-icon"><i class="material-icons">sell</i></div><div><strong>${t.gig_1}</strong></div></div><div class="gig-highlight"><div class="gig-icon"><i class="material-icons">percent</i></div><div><strong>${t.gig_2}</strong></div></div><div class="info-card" style="border-left: 5px solid #ffab00;"><div class="section-header"><i class="material-icons">payments</i> ${t.fee_t}</div><div style="text-align:center; padding:10px 0;"><div style="font-size:2.5rem; font-weight:900; color:#212121;">${t.fee_v}</div><div style="text-transform:uppercase; font-size:0.8rem; color:#757575; letter-spacing:1px;">${t.fee_l}</div></div><p style="text-align:center; margin-top:10px; font-size:0.9rem;">${t.fee_d}</p></div><div class="welcome-footer"><a href="https://speedo.lk">${t.links_web}</a><a href="#">${t.links_priv}</a></div></div></div>`;
            document.body.appendChild(overlay);
        }

        function mkInput(l, t, v) {
            const d=document.createElement('div'); d.className='input-group';
            d.innerHTML = `<label>${l}</label><input type="${t}" value="${v||''}">`;
            return d;
        }
        function mkSelect(l, opts) {
            const d=document.createElement('div'); d.className='input-group';
            let h = `<label>${l}</label><select><option value="" disabled selected>Select</option>`;
            opts.forEach(o => h+=`<option value="${o}">${o}</option>`);
            h += `</select>`; d.innerHTML=h; return d;
        }
    </script>
</body>
</html>
