<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPEEDO User</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        :root {
            --primary: #E31C25;
            --dark: #1a1a1a;
            --gray: #f4f6f8;
            --white: #ffffff;
            --shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { height: 100vh; width: 100vw; overflow: hidden; background: var(--gray); display: flex; flex-direction: column; }

        /* MAP */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .leaflet-control-attribution { display: none !important; } /* Hide Leaflet Label */
        
        /* UI LAYERS */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; display: flex; flex-direction: column; }
        .interactive { pointer-events: auto; }

        /* Header */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .menu-btn { background: var(--white); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); cursor: pointer; color: var(--dark); font-size: 1.2rem; }
        .user-pill { background: var(--white); padding: 5px 15px 5px 5px; border-radius: 30px; font-weight: 600; font-size: 0.9rem; box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; }
        .user-pill img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid var(--primary); }

        /* Search Card */
        .search-card { background: var(--white); margin: 20px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .loc-input { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--gray); border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .dot { width: 8px; height: 8px; background: black; border-radius: 50%; }
        .sq { width: 8px; height: 8px; background: var(--primary); }
        .loc-text { font-size: 0.9rem; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .confirm-btn { background: var(--dark); color: white; width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 600; cursor: pointer; display: none; }

        /* Center Pin */
        .center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 500; font-size: 3rem; color: var(--dark); display: none; pointer-events: none; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .center-pin.active { display: block; animation: bounce 0.4s ease infinite alternate; }
        @keyframes bounce { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, -110%); } }

        /* Bottom Sheets */
        .bottom-sheet {
            background: var(--white); border-radius: 30px 30px 0 0; padding: 20px;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.15); position: absolute; bottom: 0; left: 0; width: 100%;
            transform: translateY(110%); transition: transform 0.3s ease-out;
            max-height: 70vh; display: flex; flex-direction: column;
        }
        .bottom-sheet.active { transform: translateY(0); }

        /* Vehicle List */
        .veh-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 5px 0 15px 0; scrollbar-width: none; }
        .veh-item { min-width: 100px; padding: 10px; border: 2px solid #eee; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .veh-item.selected { border-color: var(--primary); background: #fff5f5; }
        .veh-img { width: 60px; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .veh-name { font-weight: 700; font-size: 0.8rem; }
        .veh-est { font-size: 0.75rem; color: #777; }

        /* Driver List */
        .driver-list { overflow-y: auto; max-height: 40vh; margin-top: 10px; }
        .driver-card { display: flex; gap: 15px; padding: 15px; border: 1px solid #eee; border-radius: 15px; margin-bottom: 10px; align-items: center; }
        .d-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .d-info { flex: 1; }
        .d-name { font-weight: 700; font-size: 0.95rem; }
        .d-meta { font-size: 0.75rem; color: #666; display: flex; gap: 10px; }
        .d-price { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .book-btn { background: var(--dark); color: white; padding: 8px 20px; border-radius: 20px; border: none; font-size: 0.8rem; cursor: pointer; }

        /* Active Trip */
        .trip-status { text-align: center; font-weight: 700; color: var(--primary); margin-bottom: 15px; padding: 10px; background: #fff5f5; border-radius: 10px; }
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .act-btn { padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .call { background: var(--dark); color: white; text-decoration: none; }
        .cancel { background: #ffebee; color: #c62828; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 85%; padding: 25px; border-radius: 20px; text-align: center; }
        
        .stars { font-size: 2.5rem; color: #ddd; margin: 20px 0; display: flex; justify-content: center; gap: 5px; cursor: pointer; }
        .stars i.active { color: #FFC107; }

        /* Menu Sidebar */
        #side-menu { position: fixed; top: 0; left: -100%; width: 280px; height: 100%; background: white; z-index: 1500; transition: 0.3s; padding: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #side-menu.active { left: 0; }
        .menu-header { display: flex; align-items: center; gap: 15px; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .menu-item { padding: 15px; font-weight: 600; color: #333; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1400; display: none; }
        .menu-overlay.active { display: block; }

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 5000; }
        #toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>

    <!-- Map -->
    <div id="map"></div>
    <div class="center-pin interactive" id="map-pin"><i class="fa-solid fa-location-dot"></i></div>

    <!-- UI -->
    <div class="ui-layer">
        
        <!-- Header -->
        <div class="header interactive">
            <div class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
            <div class="user-pill" onclick="toggleMenu()">
                <span id="header-name">Guest</span>
                <img id="header-pic" src="">
            </div>
        </div>

        <!-- Search -->
        <div class="search-card interactive" id="search-panel" style="margin: 20px;">
            <h3 style="margin-bottom: 15px;">Where to?</h3>
            <div class="loc-input" onclick="pickLocation('pickup')">
                <div class="dot"></div> <div class="loc-text" id="txt-pickup">Current Location</div>
            </div>
            <div class="loc-input" onclick="pickLocation('drop')">
                <div class="sq"></div> <div class="loc-text" id="txt-drop" style="color: var(--dark); font-weight: 700;">Set Destination</div>
            </div>
            <button class="confirm-btn" id="btn-confirm" onclick="confirmLocation()">Set Location</button>
        </div>

        <!-- Vehicle Sheet -->
        <div id="sheet-vehicles" class="bottom-sheet interactive">
            <h3 style="margin-bottom: 10px;">Select Ride</h3>
            <div class="veh-scroll" id="veh-list"></div>
            <div style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
                <h4 style="margin-bottom: 10px;">Drivers Nearby</h4>
                <div class="driver-list" id="driver-list-container">
                    <p style="text-align: center; color: #999; margin-top: 20px;">Select a vehicle type first</p>
                </div>
            </div>
        </div>

        <!-- Active Trip Sheet -->
        <div id="sheet-trip" class="bottom-sheet interactive">
            <div class="trip-status" id="trip-status">Contacting Driver...</div>
            
            <div class="driver-card" style="border: none; padding: 0;">
                <img id="td-img" src="" class="d-img" style="width: 70px; height: 70px;">
                <div class="d-info">
                    <div id="td-name" class="d-name" style="font-size: 1.1rem;">Driver Name</div>
                    <div id="td-veh" class="d-meta">Vehicle • Plate</div>
                    <div class="d-meta" style="margin-top: 5px; color: gold;"><i class="fa-solid fa-star"></i> <span id="td-rating">5.0</span></div>
                </div>
            </div>

            <div class="action-row">
                <a href="#" id="td-call" class="act-btn call"><i class="fa-solid fa-phone"></i> Call</a>
                <button class="act-btn cancel" onclick="cancelRide()"><i class="fa-solid fa-xmark"></i> Cancel</button>
            </div>
        </div>

    </div>

    <!-- Sidebar -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    <div id="side-menu">
        <div class="menu-header">
            <img id="menu-pic" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
            <div>
                <h4 id="menu-name" style="margin: 0;">User</h4>
                <small id="menu-phone" style="color: #666;">Phone</small>
            </div>
        </div>
        <div class="menu-item" style="color: var(--primary); margin-top: auto;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Log Out</div>
    </div>

    <!-- Rating Modal -->
    <div id="rating-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>Rate Driver</h2>
            <div class="stars" id="rating-stars">
                <i class="fa-solid fa-star" onclick="rate(1)"></i><i class="fa-solid fa-star" onclick="rate(2)"></i>
                <i class="fa-solid fa-star" onclick="rate(3)"></i><i class="fa-solid fa-star" onclick="rate(4)"></i><i class="fa-solid fa-star" onclick="rate(5)"></i>
            </div>
            <button class="confirm-btn" style="display: block; background: var(--primary);" onclick="submitRating()">Submit</button>
        </div>
    </div>

    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXDoV_y0FKcKz2OdbY6UT5qTpCwkokJqg",
            authDomain: "speedo-a162d.firebaseapp.com",
            databaseURL: "https://speedo-a162d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "speedo-a162d",
            storageBucket: "speedo-a162d.firebasestorage.app",
            messagingSenderId: "944425759845",
            appId: "1:944425759845:web:f523b6ddbda9216d3c828c"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State
        const userId = localStorage.getItem('speedo_user_id');
        let map, routeControl;
        let pickMode = null, locPickup = null, locDrop = null, tripDist = 0;
        let nearbyDrivers = [], attemptedDrivers = [];
        let selectedVehType = null;
        let currentDriverId = null, currentRideId = null;
        let driverUnsubscribe = null; // Store function to unsubscribe
        let ratingVal = 0;

        const vehicles = [
            { id: 'Bike', name: 'Bike', icon: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png', base: 60, rate: 40 },
            { id: 'Tuk', name: 'Tuk', icon: 'https://cdn-icons-png.flaticon.com/512/3082/3082390.png', base: 80, rate: 60 },
            { id: 'Car', name: 'Car', icon: 'https://cdn-icons-png.flaticon.com/512/3082/3082361.png', base: 150, rate: 120 }
        ];

        window.onload = () => {
            if(!userId) window.location.href = 'index.html';
            loadUserProfile();
            initMap();
        };

        async function loadUserProfile() {
            try {
                const snap = await get(ref(db, `users/${userId}`));
                if(snap.exists()) {
                    const u = snap.val();
                    const name = u.fullName || "User";
                    const pic = u.profileImage || "https://via.placeholder.com/50";
                    document.getElementById('header-name').innerText = name.split(' ')[0];
                    document.getElementById('menu-name').innerText = name;
                    document.getElementById('menu-phone').innerText = u.phone;
                    document.getElementById('header-pic').src = pic;
                    document.getElementById('menu-pic').src = pic;
                }
            } catch(e) { console.error(e); }
        }

        // --- MAP ---
        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([6.9271, 79.8612], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    locPickup = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    L.circleMarker(locPickup, { radius: 8, fillColor: '#E31C25', color: '#fff', weight: 3, fillOpacity: 1 }).addTo(map);
                    map.setView(locPickup, 16);
                    reverseGeocode(locPickup, 'txt-pickup');
                });
            }
            map.on('moveend', () => {
                if(pickMode) {
                    const c = map.getCenter();
                    reverseGeocode(c, pickMode==='pickup'?'txt-pickup':'txt-drop');
                }
            });
        }

        window.pickLocation = (mode) => {
            pickMode = mode;
            document.getElementById('map-pin').style.display = 'block';
            document.getElementById('search-panel').classList.add('hidden');
            document.getElementById('btn-confirm').innerText = mode==='pickup'?"Set Pickup":"Set Destination";
            document.getElementById('btn-confirm').style.display='block';
        }

        window.confirmLocation = () => {
            const c = map.getCenter();
            if(pickMode==='pickup') locPickup = {lat:c.lat, lng:c.lng};
            else locDrop = {lat:c.lat, lng:c.lng};
            
            pickMode = null;
            document.getElementById('map-pin').style.display = 'none';
            document.getElementById('btn-confirm').style.display='none';
            document.getElementById('search-panel').classList.remove('hidden');

            if(locPickup && locDrop) drawRoute();
        }

        async function reverseGeocode(coords, elId) {
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}`);
                const d = await r.json();
                document.getElementById(elId).innerText = d.display_name.split(',')[0];
            } catch(e) {}
        }

        function drawRoute() {
            if(routeControl) map.removeControl(routeControl);
            routeControl = L.Routing.control({
                waypoints: [L.latLng(locPickup), L.latLng(locDrop)],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{ color: '#1a1a1a', weight: 5 }] },
                createMarker: ()=>null, addWaypoints: false, fitSelectedRoutes: true, showAlternatives: false, containerClassName: 'hidden-instructions' 
            }).addTo(map);
            
            // Hide the default routing box using CSS logic
            const container = document.querySelector('.leaflet-routing-container');
            if(container) container.style.display = 'none';

            routeControl.on('routesfound', e => {
                tripDist = e.routes[0].summary.totalDistance / 1000;
                renderVehicles();
            });
        }

        // --- VEHICLES & DRIVERS ---
        function renderVehicles() {
            const list = document.getElementById('veh-list'); list.innerHTML = '';
            document.getElementById('search-panel').classList.add('hidden');
            document.getElementById('sheet-vehicles').classList.add('active');

            vehicles.forEach(v => {
                const price = Math.round(v.base + (tripDist > 1 ? (tripDist-1)*v.rate : 0));
                const div = document.createElement('div');
                div.className = 'veh-item';
                div.innerHTML = `<img src="${v.icon}" class="veh-img"><div class="veh-name">${v.name}</div><div class="veh-est">${price}</div>`;
                div.onclick = () => {
                    document.querySelectorAll('.veh-item').forEach(i=>i.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedVehType = v.id;
                    scanDrivers(v.id, v.base, v.rate);
                };
                list.appendChild(div);
            });
        }

        async function scanDrivers(type, base, rate) {
            const list = document.getElementById('driver-list-container');
            list.innerHTML = '<p style="text-align:center;">Scanning...</p>';
            
            const snap = await get(ref(db, `active_gigs/${type}`));
            nearbyDrivers = [];

            if(snap.exists()) {
                snap.forEach(c => {
                    const d = c.val();
                    if(d.location && (d.active_session==='searching' || d.availability===true || d.availability==='idle')) {
                        const dist = map.distance(locPickup, d.location) / 1000;
                        if(dist <= 15) {
                            const total = (d.accepts||0) + (d.declines||0);
                            const acc = total ? Math.round((d.accepts/total)*100) : 100;
                            const dec = total ? Math.round((d.declines/total)*100) : 0;
                            const dRate = d.price_per_100m ? (parseFloat(d.price_per_100m)*10) : rate;
                            let price = base;
                            if(tripDist > 1) price += (tripDist-1)*dRate;

                            nearbyDrivers.push({ ...d, dist, price: Math.round(price), acc, dec });
                        }
                    }
                });
            }

            nearbyDrivers.sort((a,b) => a.price - b.price);
            renderDriverList();
        }

        function renderDriverList() {
            const list = document.getElementById('driver-list-container'); list.innerHTML = '';
            if(!nearbyDrivers.length) { list.innerHTML = '<p style="text-align:center; color:red;">No drivers nearby</p>'; return; }

            nearbyDrivers.forEach(d => {
                const el = document.createElement('div');
                el.className = 'driver-card';
                el.innerHTML = `
                    <img src="${d.profile_pic||''}" class="d-img">
                    <div class="d-info">
                        <div class="d-name">${d.driver_name}</div>
                        <div class="d-meta">
                            <span><i class="fa-solid fa-check" style="color:green;"></i> ${d.acc}%</span>
                            <span><i class="fa-solid fa-xmark" style="color:red;"></i> ${d.dec}%</span>
                            <span>${d.dist.toFixed(1)} km</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="d-price">${d.price} LKR</div>
                        <button class="book-btn" onclick="bookDriver('${d.driver_id}', ${d.price})">Book</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- BOOKING LOGIC ---
        window.bookDriver = async (did, price) => {
            currentDriverId = did;
            attemptedDrivers = [did];
            initiateRequest(did, price);
        };

        async function initiateRequest(did, price) {
            const driverInfo = nearbyDrivers.find(d => d.driver_id === did);
            if(!driverInfo) return showToast("Driver Error");

            // UI
            document.getElementById('sheet-vehicles').classList.remove('active');
            document.getElementById('sheet-trip').classList.add('active');
            document.getElementById('trip-status').innerText = "Contacting Driver...";
            document.getElementById('td-name').innerText = driverInfo.driver_name;
            document.getElementById('td-veh').innerText = `${selectedVehType} • ${driverInfo.vehicle_plate}`;
            document.getElementById('td-img').src = driverInfo.profile_pic;
            document.getElementById('td-rating').innerText = driverInfo.rating || "5.0";
            document.getElementById('td-call').href = `tel:${driverInfo.mobile}`;

            // Create Request
            const newRef = push(ref(db, 'ride_requests'));
            currentRideId = newRef.key;
            
            await set(newRef, {
                ride_id: currentRideId, user_id: userId, driver_id: did, pickup: locPickup, dropoff: locDrop,
                vehicle: selectedVehType, estimated_price: price, status: 'pending', timestamp: Date.now()
            });
            
            // Trigger Driver
            await update(ref(db, `active_gigs/${selectedVehType}/${did}`), { active_session: 'ride', availability: 'idle' });

            monitorDriverStatus(did);
        }

        function monitorDriverStatus(did) {
            const driverRef = ref(db, `active_gigs/${selectedVehType}/${did}`);
            
            // CLEAN UNSUBSCRIBE: Use return value
            driverUnsubscribe = onValue(driverRef, (snap) => {
                const d = snap.val();
                if(!d) { fallback(); return; }

                if(d.active_session === 'confirmed' || d.active_session === 'accepted' || d.active_session === 'arrived' || d.active_session === 'started') {
                    if(d.active_session === 'arrived') updateStatus("Driver Arrived", "#fff3cd", "#856404");
                    else if(d.active_session === 'started') updateStatus("Trip Started", "#d4edda", "#155724");
                    else updateStatus("Driver Coming", "#d1ecf1", "#0c5460");
                }
                // AUTO FALLBACK
                else if(d.active_session === 'searching' && d.availability === true) {
                    showToast("Driver Declined. Finding next...", "error");
                    // Unsubscribe immediately
                    if(driverUnsubscribe) { driverUnsubscribe(); driverUnsubscribe = null; }
                    fallback(); 
                }
            });
            
            // Listen for Pay
            onValue(ref(db, `ride_requests/${currentRideId}`), (snap) => {
                const r = snap.val();
                if(r && r.status === 'paid') endTrip();
            });
        }

        function updateStatus(text, bg, col) {
            const el = document.getElementById('trip-status');
            el.innerText = text; el.style.background = bg; el.style.color = col;
        }

        function fallback() {
            if(currentRideId) remove(ref(db, `ride_requests/${currentRideId}`));
            
            const nextDriver = nearbyDrivers.find(d => !attemptedDrivers.includes(d.driver_id));
            if(nextDriver) {
                attemptedDrivers.push(nextDriver.driver_id);
                initiateRequest(nextDriver.driver_id, nextDriver.price);
            } else {
                showToast("Retrying first driver...", "warning");
                attemptedDrivers = [];
                const first = nearbyDrivers[0];
                if(first) {
                    attemptedDrivers.push(first.driver_id);
                    initiateRequest(first.driver_id, first.price);
                } else {
                    cancelRide();
                    showToast("No drivers available.");
                }
            }
        }

        window.cancelRide = () => {
            if(driverUnsubscribe) { driverUnsubscribe(); driverUnsubscribe = null; }
            if(currentRideId) remove(ref(db, `ride_requests/${currentRideId}`));
            if(currentDriverId) update(ref(db, `active_gigs/${selectedVehType}/${currentDriverId}`), { active_session: 'searching', availability: true });
            
            document.getElementById('sheet-trip').classList.remove('active');
            document.getElementById('search-panel').classList.remove('hidden');
            initMap();
        };

        // --- RATING ---
        function endTrip() {
            document.getElementById('sheet-trip').classList.remove('active');
            document.getElementById('rating-modal').style.display = 'flex';
        }

        window.rate = (n) => { ratingVal = n; document.querySelectorAll('.stars i').forEach((s,i)=>s.classList.toggle('active', i<n)); };

        window.submitRating = async () => {
            if(!ratingVal) return showToast("Please rate");
            const dRef = ref(db, `drivers/${currentDriverId}`);
            const snap = await get(dRef);
            if(snap.exists()) {
                const d = snap.val();
                let r = parseFloat(d.rating || 0.00);
                if(r===0) r=5.00;
                if(ratingVal === 5) r += 0.05; else if(ratingVal < 3) r -= 0.02;
                if(r > 5) r = 5.00; if(r < 0) r = 0.00;
                await update(dRef, { rating: r.toFixed(2) });
            }
            document.getElementById('rating-modal').style.display='none';
            cancelRide();
            showToast("Thank you!");
        };

        window.toggleMenu = () => { document.getElementById('side-menu').classList.toggle('active'); document.getElementById('menu-overlay').classList.toggle('active'); };
        window.logout = () => { localStorage.clear(); window.location.href='index.html'; };
        function showToast(m, t) { const x=document.getElementById('toast'); x.innerText=m; x.style.background=t==='error'?'#d63031':'#333'; x.classList.add('show'); setTimeout(()=>x.classList.remove('show'),3000); }
        window.bookDriver = window.bookDriver;
    </script>
</body>
</html>
