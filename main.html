<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPEEDO User</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #E31C25; --text: #333; --bg: #f4f6f8; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); height:100vh; overflow:hidden; display:flex; flex-direction:column; }
        
        /* Map & UI Layers */
        #map { width:100%; height:100vh; z-index:0; }
        .ui-overlay { position:fixed; inset:0; pointer-events:none; z-index:1000; display:flex; flex-direction:column; }
        .pointer-auto { pointer-events:auto; }
        
        /* Cards */
        .bottom-card {
            background:white; border-radius:20px 20px 0 0; padding:20px;
            box-shadow:0 -5px 20px rgba(0,0,0,0.1); margin-top:auto;
            transform:translateY(100%); transition:0.3s; max-height:80vh; overflow-y:auto;
        }
        .bottom-card.active { transform:translateY(0); }

        /* Inputs */
        .search-trigger { background:white; margin:20px; padding:15px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); display:flex; gap:10px; align-items:center; cursor:pointer; }
        
        /* Ride UI */
        .driver-info-strip { display:flex; align-items:center; gap:15px; padding-bottom:15px; border-bottom:1px solid #eee; margin-bottom:15px; }
        .driver-pic { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); }
        .status-badge { background:#eee; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:700; }
        .chat-box { height:150px; background:#f9f9f9; border-radius:10px; overflow-y:auto; padding:10px; margin-bottom:10px; border:1px solid #eee; }
        .chat-msg { margin-bottom:5px; font-size:12px; padding:5px 8px; border-radius:8px; max-width:80%; }
        .chat-msg.me { background:#e3f2fd; margin-left:auto; }
        .chat-msg.them { background:white; border:1px solid #ddd; }

        .btn { width:100%; padding:12px; border:none; border-radius:10px; font-weight:600; cursor:pointer; background:#eee; color:#333; margin-top:5px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-green { background:#2e7d32; color:white; }
        
        .full-screen { position:fixed; inset:0; background:white; z-index:2000; display:none; flex-direction:column; }
        .full-screen.show { display:flex; }
        
        /* Vehicle List */
        .veh-item { padding:10px; border:1px solid #eee; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .veh-item.selected { border-color:var(--primary); background:#fff5f5; }

        /* Animation */
        .pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity:1; } 50% { opacity:0.5; } 100% { opacity:1; } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="ui-overlay">
        <!-- Header -->
        <div class="pointer-auto search-trigger" onclick="openSearch()">
            <i class="fa-solid fa-bars"></i>
            <span id="loc-display">Where to go?</span>
        </div>

        <!-- 1. Vehicle Selection Panel -->
        <div id="panel-select" class="pointer-auto bottom-card">
            <h3>Select Ride</h3>
            <div id="veh-list" style="margin:15px 0;"></div>
            <button class="btn btn-primary" onclick="requestRide()">Find Driver</button>
        </div>

        <!-- 2. Searching / Finding Panel -->
        <div id="panel-searching" class="pointer-auto bottom-card" style="text-align:center;">
            <div class="pulse" style="font-size:40px; color:var(--primary); margin-bottom:15px;">
                <i class="fa-solid fa-satellite-dish"></i>
            </div>
            <h3>Connecting...</h3>
            <p>Finding the best driver for you.</p>
            <button class="btn" onclick="cancelRequest()">Cancel</button>
        </div>

        <!-- 3. Active Ride Panel -->
        <div id="panel-ride" class="pointer-auto bottom-card">
            <div class="driver-info-strip">
                <img id="d-pic" src="" class="driver-pic">
                <div style="flex:1;">
                    <h4 id="d-name">Driver Name</h4>
                    <div style="font-size:12px; color:#666;"><span id="d-veh">Vehicle</span> â€¢ <span id="d-plate">ABC-1234</span></div>
                </div>
                <div class="status-badge" id="ride-status">COMING</div>
                <a id="d-call" href="#" class="btn btn-green" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; text-decoration:none;"><i class="fa-solid fa-phone"></i></a>
            </div>
            
            <!-- Chat Area -->
            <div class="chat-box" id="chat-feed"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-input" placeholder="Message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:20px;">
                <button onclick="sendMsg()" style="width:40px; height:40px; border-radius:50%; border:none; background:var(--primary); color:white;"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
        
        <!-- 4. Rating Panel -->
        <div id="panel-rating" class="pointer-auto bottom-card" style="text-align:center;">
            <h2 style="color:var(--primary);">Ride Completed!</h2>
            <h1 id="final-bill" style="font-size:3rem; margin:10px 0;">0 LKR</h1>
            <p>How was your driver?</p>
            <div style="font-size:30px; color:gold; margin:15px 0;">
                <i class="fa-solid fa-star" onclick="rate(1)"></i>
                <i class="fa-solid fa-star" onclick="rate(2)"></i>
                <i class="fa-solid fa-star" onclick="rate(3)"></i>
                <i class="fa-solid fa-star" onclick="rate(4)"></i>
                <i class="fa-solid fa-star" onclick="rate(5)"></i>
            </div>
            <button class="btn btn-primary" onclick="submitRating()">Submit & Close</button>
        </div>
    </div>

    <!-- Search Overlay -->
    <div id="screen-search" class="full-screen">
        <div style="padding:20px; display:flex; gap:10px;">
            <button onclick="closeSearch()" style="background:none; border:none;"><i class="fa-solid fa-arrow-left"></i></button>
            <input id="inp-pickup" placeholder="Pickup Location" value="Current Location" style="width:100%; padding:10px;">
        </div>
        <div style="padding:0 20px;">
            <input id="inp-dropoff" placeholder="Where to?" onchange="calcRoute()" style="width:100%; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:8px;">
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXDoV_y0FKcKz2OdbY6UT5qTpCwkokJqg",
            authDomain: "speedo-a162d.firebaseapp.com",
            databaseURL: "https://speedo-a162d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "speedo-a162d",
            storageBucket: "speedo-a162d.firebasestorage.app",
            messagingSenderId: "944425759845",
            appId: "1:944425759845:web:f523b6ddbda9216d3c828c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State
        const userId = localStorage.getItem('speedo_uid') || 'user_' + Date.now();
        localStorage.setItem('speedo_uid', userId);
        
        let map, userMarker, driverMarker, routeLine;
        let pickupCoords = null, dropoffCoords = null;
        let availableDrivers = [];
        let selectedVehicle = 'Tuk';
        let currentRequestId = null;
        let rejectedDrivers = [];
        let rideListener = null;

        // Init
        window.onload = () => {
            map = L.map('map', {zoomControl:false}).setView([6.9271, 79.8612], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    pickupCoords = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                    map.setView(pickupCoords, 16);
                    userMarker = L.marker(pickupCoords).addTo(map).bindPopup("You");
                    updateAddress(pickupCoords);
                    fetchNearbyDrivers();
                });
            }
        };

        // --- CORE FUNCTIONS ---

        function openSearch() { document.getElementById('screen-search').classList.add('show'); }
        function closeSearch() { document.getElementById('screen-search').classList.remove('show'); }

        async function updateAddress(coords) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lng}&format=json`);
                const data = await res.json();
                document.getElementById('loc-display').innerText = data.display_name.split(',')[0];
                document.getElementById('inp-pickup').value = data.display_name.split(',')[0];
            } catch(e) {}
        }

        async function calcRoute() {
            const query = document.getElementById('inp-dropoff').value;
            if(!query) return;
            
            // Geocode dropoff
            const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1&countrycodes=lk`);
            const data = await res.json();
            if(!data.length) return alert("Location not found");
            
            dropoffCoords = {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)};
            closeSearch();
            
            // Draw Route
            const routeUrl = `https://router.project-osrm.org/route/v1/driving/${pickupCoords.lng},${pickupCoords.lat};${dropoffCoords.lng},${dropoffCoords.lat}?overview=full&geometries=geojson`;
            const rRes = await fetch(routeUrl);
            const rData = await rRes.json();
            
            if(rData.routes.length) {
                const r = rData.routes[0];
                const latlngs = r.geometry.coordinates.map(c => [c[1], c[0]]);
                if(routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline(latlngs, {color: '#E31C25', weight: 5}).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding:[50,50]});
                
                // Show Vehicle Panel
                const distKm = r.distance / 1000;
                showVehicleSelect(distKm);
            }
        }

        function showVehicleSelect(dist) {
            document.getElementById('panel-select').classList.add('active');
            const list = document.getElementById('veh-list');
            list.innerHTML = '';
            
            // Calculate prices based on nearby available drivers
            const types = ['Bike', 'Tuk', 'Car', 'Van'];
            types.forEach(type => {
                // Find drivers of this type
                const drivers = availableDrivers.filter(d => d.key === type);
                if(drivers.length > 0) {
                    // Average price
                    const avgRate = drivers.reduce((acc, d) => acc + parseFloat(d.data.price_per_100m || 10), 0) / drivers.length;
                    const price = Math.ceil(100 + (dist * 10 * avgRate)); // Base 100 + logic
                    
                    const div = document.createElement('div');
                    div.className = `veh-item ${selectedVehicle === type ? 'selected' : ''}`;
                    div.innerHTML = `<span><b>${type}</b> <small>${drivers.length} nearby</small></span> <b>${price} LKR</b>`;
                    div.onclick = () => {
                        selectedVehicle = type;
                        showVehicleSelect(dist);
                    };
                    list.appendChild(div);
                }
            });
            if(list.innerHTML === '') list.innerHTML = '<p>No drivers nearby</p>';
        }

        function fetchNearbyDrivers() {
            db.ref('active_gigs').on('value', snap => {
                availableDrivers = [];
                if(snap.exists()) {
                    snap.forEach(typeSnap => {
                        typeSnap.forEach(dSnap => {
                            const d = dSnap.val();
                            if(d.availability) {
                                availableDrivers.push({key: typeSnap.key, id: dSnap.key, data: d});
                            }
                        });
                    });
                }
            });
        }

        // --- BOOKING LOGIC ---

        function requestRide() {
            // Filter drivers by type
            let candidates = availableDrivers.filter(d => d.key === selectedVehicle && !rejectedDrivers.includes(d.id));
            
            if(candidates.length === 0) {
                document.getElementById('panel-searching').classList.remove('active');
                document.getElementById('panel-select').classList.add('active');
                alert("No drivers found or all declined. Try another vehicle type.");
                rejectedDrivers = []; // Reset for retry
                return;
            }

            // Sort by price (cheapest first)
            candidates.sort((a,b) => parseFloat(a.data.price_per_100m) - parseFloat(b.data.price_per_100m));
            const targetDriver = candidates[0];

            document.getElementById('panel-select').classList.remove('active');
            document.getElementById('panel-searching').classList.add('active');

            if(!currentRequestId) {
                // Create New Request
                currentRequestId = db.ref('ride_requests').push().key;
            }

            const reqData = {
                id: currentRequestId,
                user_id: userId,
                driver_id: targetDriver.id, // THE CHOSEN ONE
                status: 'pending',
                pickup: pickupCoords,
                dropoff: dropoffCoords,
                vehicle: selectedVehicle,
                timestamp: Date.now(),
                rejected_drivers: rejectedDrivers,
                waiting_time: 0
            };

            db.ref('ride_requests/' + currentRequestId).set(reqData);
            
            // Listen for changes
            if(rideListener) db.ref('ride_requests/' + currentRequestId).off();
            rideListener = db.ref('ride_requests/' + currentRequestId).on('value', handleRideUpdate);
        }

        function handleRideUpdate(snap) {
            if(!snap.exists()) return;
            const ride = snap.val();

            // 1. Check if Driver Declined
            if(ride.status === 'pending' && ride.driver_id !== ride.driver_id_prev) {
                // Wait... if driver declines, the driver app updates 'rejected_drivers' ? 
                // Actually, let's make the USER app intelligent.
                // The driver app will just set status back to 'declined' or similar?
                // Standard Logic: Driver App sets rejected_drivers in DB. User App sees it.
            }
            
            // Logic: If driver declined (status stays pending but rejected_drivers grew) OR explicit 'declined' status
            if(ride.rejected_drivers && ride.rejected_drivers.length > rejectedDrivers.length) {
                console.log("Driver declined, finding next...");
                rejectedDrivers = ride.rejected_drivers;
                requestRide(); // Recursively find next
                return;
            }

            // 2. Accepted
            if(ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'in_progress') {
                document.getElementById('panel-searching').classList.remove('active');
                document.getElementById('panel-ride').classList.add('active');
                updateRideUI(ride);
                trackDriver(ride.driver_id);
            }

            // 3. Status Updates
            const statusBadge = document.getElementById('ride-status');
            if(ride.status === 'arrived') { statusBadge.innerText = "DRIVER ARRIVED"; statusBadge.style.background = "orange"; }
            if(ride.status === 'in_progress') { statusBadge.innerText = "ON TRIP"; statusBadge.style.background = "#E31C25"; statusBadge.style.color = "white"; }
            
            // 4. Completed
            if(ride.status === 'completed') {
                document.getElementById('panel-ride').classList.remove('active');
                document.getElementById('panel-rating').classList.add('active');
                document.getElementById('final-bill').innerText = Math.ceil(ride.final_price) + " LKR";
                if(driverMarker) map.removeLayer(driverMarker);
                routeLine.remove();
                
                // Save to activities
                db.ref('activities/' + userId + '/' + ride.id).set(ride);
            }

            // Chat Sync
            if(ride.chat) renderChat(ride.chat);
        }

        function updateRideUI(ride) {
            // Get driver details from active_gigs (fast) or drivers node
            db.ref('drivers/' + ride.driver_id).once('value', s => {
                const d = s.val();
                document.getElementById('d-name').innerText = d.name;
                document.getElementById('d-veh').innerText = ride.vehicle;
                document.getElementById('d-plate').innerText = d.vehiclePlate;
                document.getElementById('d-pic').src = d.profile_pic || 'https://via.placeholder.com/50';
                document.getElementById('d-call').href = `tel:${d.mobile}`;
            });
        }

        function trackDriver(dId) {
            db.ref(`active_gigs/${selectedVehicle}/${dId}/location`).on('value', s => {
                const loc = s.val();
                if(!loc) return;
                
                if(driverMarker) driverMarker.setLatLng(loc);
                else {
                    driverMarker = L.marker(loc, {
                        icon: L.divIcon({
                            className: 'car-icon',
                            html: '<i class="fa-solid fa-car-side" style="color:red; font-size:24px; background:white; border-radius:50%; padding:5px; border:2px solid red;"></i>'
                        })
                    }).addTo(map);
                }
            });
        }

        function cancelRequest() {
            if(currentRequestId) {
                db.ref('ride_requests/' + currentRequestId).remove();
                currentRequestId = null;
            }
            document.getElementById('panel-searching').classList.remove('active');
            document.getElementById('panel-select').classList.add('active');
            rejectedDrivers = [];
        }

        // --- CHAT & RATING ---
        function sendMsg() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            const msg = { sender: 'user', text: txt, time: Date.now() };
            
            // Add to array
            db.ref(`ride_requests/${currentRequestId}/chat`).push(msg);
            document.getElementById('chat-input').value = '';
        }

        function renderChat(chatObj) {
            const div = document.getElementById('chat-feed');
            div.innerHTML = '';
            Object.values(chatObj).forEach(m => {
                const p = document.createElement('div');
                p.className = `chat-msg ${m.sender === 'user' ? 'me' : 'them'}`;
                p.innerText = m.text;
                div.appendChild(p);
            });
            div.scrollTop = div.scrollHeight;
        }

        function rate(stars) {
            // Visual only for now
            alert(`Rated ${stars} stars`);
        }
        function submitRating() {
            location.reload(); // Reset App
        }

    </script>
</body>
</html>
